\documentclass{article}
 
\usepackage{amscd}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{stmaryrd}
\usepackage{mathpartir}
\usepackage{multicol}
\usepackage{enumitem}
\usepackage[section]{placeins} % float barriers
\usepackage{natbib}
\usepackage{xcolor} 
\usepackage{bussproofs} 
\usepackage{diagrams}
\usepackage{tikz}

\usetikzlibrary{cd}
 
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}

%example: \limit{j \in J}{F_j}
\newcommand{\limit}[2]{\underset{\overset{\longleftarrow}{#1}}{\text{lim}}~#2}
\newcommand{\lims}[1]{\underset{\longleftarrow}{\text{lim}}~#1}
\newcommand{\mbf}{\mathbf}
\newcommand{\sem}[1]{\llbracket #1 \rrbracket}
\newcommand{\bimpl}[2]{
\mprset{fraction={===}}
\inferrule{#1}{#2 }
}
\newcommand{\inconsist}{\mathrel{\substack{\smile \\ \frown}}}
\newcommand{\consist}{\mathrel{\substack{\frown \\ \smile}}}

\newcommand{\smc}[1]{#1}

\newcommand{\vrt}[2]{
\pile{
#1 \\
\downarrow \\
#2
}
}

\newcommand{\ddisp}[3]{
\left(
\scriptsize
\begin{tikzcd}
#1 \ar[d, "\footnotesize{#2}"] \\
#3
\end{tikzcd}
\normalsize
\right)
}

\newcommand{\disp}[3]{
\left(
\tiny
\begin{array}{c}
#1 \\
\downarrow\\
#3
\end{array}
\begin{array}{l}
~ \\
#2 \\
~
\end{array}
\normalsize
\right)
}

\newcommand{\dispp}[3]{
\tiny
\begin{tikzcd}
#1 \ar[d, "#2"] \\
#3
\end{tikzcd}
\normalsize
}

\title{Notes for: \emph{Global State Considered Unnecessary} by Uday Reddy}
\author{Kevin Clancy}

\begin{document}

\maketitle

\section*{Coherence Spaces}

\begin{lemma}
Let $\mbf{CohL}$ be the category of coherence spaces and linear maps. We define $- \otimes- : \mbf{CohL} \times \mbf{CohL} \to \mbf{CohL}$ for coherence spaces $A$ and $B$ such that $|A \otimes B| \doteq \{ (a,b) \mid a \in |A|, b \in |B| \}$ and $(a,b) \consist (a',b')~\dot{\Leftrightarrow}~(a \consist a') \wedge (b \consist b')$. For linear maps $f : A \to_L C$ and $g : B \to_L D$ we define 
$f \otimes g : A \otimes B \to_L C \otimes D \doteq \{ (a,b) \mapsto (c,d) \mid (a,c) \in f, (b,d) \in g \}$. 
Then $- \otimes - : \mbf{CohL} \times \mbf{CohL} \to \mbf{CohL}$ is a functor.
\end{lemma}

\begin{proof}
First, for coherence spaces $A$ and $B$ we have 
$$\mathit{id}_A \otimes \mathit{id}_B = \{ (a,b) \mid a \in |A|, b \in |B| \} = \{ (a,b) \mid (a,b) \in |A \otimes B| \} = \mathit{id}_{A \otimes B}$$ 
Second, for $(f,g) : (A,B) \to (C,D)$ and $(h,k) : (C,D) \to (X,Y)$ we have \\~\\
\begin{tabular}{ll}
$(f;h \otimes g;k)$ & $= \{ (a,b) \mapsto (x,y) \mid (a,x) \in f;h \wedge (b,y) \in g;k \} $ \\
~ & $= \{ (a,b) \mapsto (x,y) \mid (\exists c \in C. (a \mapsto c) \in f \wedge (c \mapsto x) \in h) \wedge (\exists d \in D. (b \mapsto d) \in g \wedge (d \mapsto y) \in k) \}$ \\ 
~ & $= \{ (a,b) \mapsto (x,y) \mid \exists (c,d) \in C \times D.~(a,b) \mapsto (c,d) \in (f \otimes g) \wedge 
  (c,d) \mapsto (x,y) \in (h \otimes k)\} $ \\
~ & $= (f \otimes g);(h \otimes k)$
\end{tabular}

\begin{definition}
Let $A$, $B$, and $C$ be coherence spaces. 
We define $l_A : \mbf{1} \otimes A \to_L A$ as the following set of tokens
$$l_A \doteq \{ (\ast,a) \mapsto a \mid a \in |A| \}$$
We define $r_A : A \otimes \mbf{1} \to_L A$ as the following set of tokens
$$r_A \doteq \{ (a,\ast) \mapsto a \mid a \in |A| \}$$
We define $s_{A,B} : A \otimes B \to_L B \otimes A$ as the following set of tokens
$$s_{A,B} \doteq \{ (a,b) \mapsto (b,a) \mid a \in |A|, b \in |B| \} $$  
We define $a_{A,B,C} : A \otimes (B \otimes C) \to (A \otimes B) \otimes C$ as the following set of tokens
$$a_{A,B,C} \doteq \{ (a,(b,c)) \mapsto ((a,b),c) \mid a \in |A|, b \in |B|, c \in |C| \}$$
\end{definition}

\begin{lemma}
Yo
\end{lemma}

\end{proof}

\section*{Appendix A: Categorical Details}

In the definition of the $\dagger-$ comonad, the first thing to note is that he is specifying these natural transformations as points in coherence spaces. The notation for the definition of $\mathit{dup}_A$ needs clarification. (At least, I needed clarification when I first saw it.) Each $s_i$ is an element of $| \dagger A |$, and $s_1 \cdots s_n$ is their concatenation, which is also an element of $| \dagger A|$. So he is quantifying over all natural numbers $n$ and all partitions $s_1 \cdots s_n$ of an arbitrary string in $| \dagger A|$.

The function corresponding to the point $\mathit{read}_A$ of 
$\dagger A \multimap A$ is:
$$\mathit{read_A}(S) \doteq \{ a \mid \langle a \rangle \in S \}$$
(It's instructive to consider the above definition in the special case that $S$ is an \emph{active} point of $\dagger A$.)

The function corresponding to the point $\mathit{dup}_A$ of $\dagger A \multimap \dagger \dagger A$ is:
$$\mathit{dup}_A(S) \doteq \{ \langle s_1,\ldots,s_n \rangle \mid n \in \mathbb N, s_1 s_2 \cdots s_n \in S \} $$

I don't think $\dagger -$'s functorial mapping on functions was defined anywhere. Here's my guess: letting $f : A \to B$ be a linear function from coherence space $A$ to coherence space $B$, we obtain a linear function $\dagger f : \dagger A \to \dagger B$ defined as:
$$\dagger f \in (\dagger A \multimap \dagger B) \doteq \{ ( \langle a_1,\ldots,a_n \rangle, \langle b_1, \ldots, b_n \rangle)  \mid (a_1,b_1),\ldots,(a_n,b_n) \in f \}$$
 
\begin{lemma}
$\mathit{read_A} : \dagger A \to A$ is a natural transformation.
\end{lemma}

\begin{proof}
Let $f : A \multimap B$ be a stable linear function between coherence spaces $A$ and $B$. Then,\\~\\
\begin{tabular}{ll}
$(z,b) \in (\mathit{read}_A;f)$ & $\mathit{iff}$ \\
$\exists a \in A.~((z,a) \in \mathit{read}_A \wedge (a,b) \in f) $ & iff \\
$\exists a \in A.~(z = \langle a \rangle \wedge (a,b) \in f)$ & iff \\

$\exists b \in B.~(z,\langle b \rangle) \in \dagger f$ & iff \\
$(z,b) \in (\dagger f;\mathit{read}_b)$ & ~ 
\end{tabular} 
\end{proof}

\begin{lemma}
$\mathit{dup}_A : \dagger A \to \dagger \dagger A$ is a natural transformation. 
\end{lemma}

\begin{proof}
Intuitively we can see that this is true since partitioning and then mapping through $f$ gives us the same results as mapping through $f$ and then partitioning.\\~\\

Let $f : A \to B$ be a stable linear function between coherence spaces $A$ and $B$. Then,\\~\\
\begin{tabular}{ll}
$(s,z) \in (\mathit{dup}_A; \dagger \dagger f)$ & iff \\~\\
 ~ & ~ \\
$s = t_1 \cdots t_m$ and $(\langle t_1, \ldots, t_m \rangle,z) \in \dagger \dagger f$ & iff \\~\\
 ~ & ~ \\
$s = t_1 \cdots t_m$ and $\forall i \in 1..m.~t_i = a_{i1} \cdots a_{i k_i}$ and \\ 
$z = \langle r_i, \ldots, r_m \rangle$ and $\forall i \in 1..m.~r_i = b_{i1} \cdots b_{i k_i}$ and $\forall i j.~(a_{ij}, b_{ij}) \in f$ & iff \\~\\
$(s,z) \in (\dagger f; \mathit{dup}_{B})$
\end{tabular}

\end{proof}

Next we show that the comonad laws hold.

\begin{lemma}
For all coherence spaces $A$, $\mathit{dup}_A;\dagger(\mathit{read}_A) = \mathit{id}_{\dagger A}$.
\end{lemma}

\begin{proof}~\\~\\
I'm going to elide the proof of this, but it's easy to see since the partition of a sequence is only in the domain of the point $\dagger (read_A)$ if it consists solely of singletons.
\end{proof}

\begin{lemma}
For all coherence spaces $A$, $\mathit{dup}_A;\mathit{read}_{\dagger A} = \mathit{id}_{\dagger A}$.
\end{lemma}

\begin{proof}
The only partition of $\langle a_1, \ldots, a_k \rangle$ in the domain of the point $\mathit{read}_{\dagger A}$ is trivial ``non-partition'' with $n=1$: $\langle \langle a_1, \ldots, a_k \rangle \rangle$. 
\end{proof}

\begin{lemma}
For all coherence spaces $A$, $\mathit{dup}_A;\mathit{dup}_{\dagger A} = \mathit{dup}_A;\dagger(\mathit{dup}_A)$.
\end{lemma}

\begin{proof}
Intuitively, this says that any token of $\dagger \dagger A$ obtained by partitioning an element $s \in \dagger A$
twice can also be obtained by paritioning $s$ and then partitioning each element of the resulting list. This 
seems obvious enough to warrant eliding the proof.
\end{proof}~\\
We now show that our friends $\mathit{merge}_{A,B}$ form a natural transformation.\\~\\
Recall that for coherence spaces $A$ and $B$, $\mathit{merge}_{A,B}$ is defined as the following point of $\dagger A \otimes \dagger B \multimap \dagger(A \otimes B)$:
$$\mathit{merge}_{A,B} \doteq \{ (\langle a_1, \ldots, a_n \rangle, \langle b_1, \ldots, b_n \rangle) \mapsto 
 \langle (a_1, b_1),\ldots,(a_n,b_n) \rangle \mid a_1, \ldots, a_n \in |A| \text{ and } b_1, \ldots, b_n \in |B|  \}$$

\begin{lemma}
$\mathit{merge} : (\dagger - \otimes \dagger -) \to \dagger(- \otimes -)$ is a natural transformation. (Between functors of type $\mbf{CohL} \times \mbf{CohL} \to \mbf{CohL}$.)
\end{lemma}

\begin{proof}
We must show that it is natural in each component separately, i.e. that for $\alpha : A \to C$ and $\beta : B \to D$ we have $$\dagger A \otimes \dagger \beta;\mathit{merge} = \mathit{merge};\dagger(A \otimes \beta)$$
and $$\dagger \alpha \otimes \dagger B;\mathit{merge} = \mathit{merge};\dagger(\alpha \otimes B)$$
Then by the bifunctor lemma (see MiscStudy pg 2817) we have~\\

\begin{tabular}{ll}
$(\dagger \alpha \otimes \dagger \beta);\mathit{merge}$ & $= (\dagger \alpha \otimes \dagger B);(\dagger A \otimes \dagger \beta);\mathit{merge}$ \\
 ~ & $= (\dagger \alpha \otimes \dagger B);\mathit{merge};\dagger(A \otimes \beta)$ \\
 ~ & $= \mathit{merge};\dagger(\alpha \otimes B);\dagger(A \otimes \beta)$ \\
 ~ & $= \mathit{merge};\dagger(\alpha \otimes \beta)$
\end{tabular}

\begin{description}

\item[Proof of $\dagger A \otimes \dagger \beta;\mathit{merge}_{A, D} = \mathit{merge}_{A, B};\dagger(A \otimes \beta)$:]~\\

\begin{tabular}{ll}
$(\langle a_1, \ldots, a_n \rangle, \langle b_1, \ldots, b_m \rangle) \mapsto \langle (a_1', d_1), \ldots, (a_k',d_k) \rangle \in \dagger A \otimes \dagger \beta;\mathit{merge}_{A, D}$ & iff \\
$(\langle a_1', \ldots, a_k' \rangle,\langle d_1, \ldots, d_k \rangle) \in \dagger A \otimes \dagger \beta.~$  & iff \\
$(n = m = k) \wedge (a_1 = a_1' \ldots a_k = a_k') \wedge (b_1,d_1),\ldots,(b_n,d_n) \in \beta$ & iff \\
$(\langle a_1, \ldots, a_n \rangle, \langle b_1, \ldots, b_m \rangle) \mapsto \langle (a_1', d_1), \ldots, (a_k',d_k) \rangle \in \mathit{merge}_{A, B};\dagger(A \otimes \beta)$ & ~
   
\end{tabular}

\item[Proof of $\dagger \alpha \otimes \dagger B;\mathit{merge}_{C,B} = \mathit{merge}_{A,B};\dagger(\alpha \otimes B)$:]~\\

Symmetric to the above.

\end{description}

\end{proof}~\\
Let's not forget our friend $\mathit{merge}_{\mbf{1}} : \mbf{1} \to_L \dagger \mbf{1}$, 
which is defined as the following token set
$$\mathit{merge}_{\mbf{1}} \doteq \{ \ast \mapsto \langle \ast \rangle^n \mid n \in \mathbb N \} $$
We now need to show that $\dagger - : \mbf{CohL} \to \mbf{CohL}$ is symmetric monoidal. 

\begin{lemma}
Let $A$ be a coherence space. Then 
$$\dagger A \otimes \mbf{1} \overset{\dagger A \otimes \mathit{merge_\mbf{1}}}{\longrightarrow} \dagger A \otimes \dagger \mbf{1} \overset{\mathit{merge}_{A,\mbf{1}}}{\longrightarrow} \dagger(A \otimes \mbf{1}) \overset{\dagger r}{\longrightarrow} \dagger A$$
is equal to
$$\dagger A \otimes \mbf{1} \overset{r}{\longrightarrow} \dagger A$$
\end{lemma}

\begin{proof}~\\

\begin{tabular}{ll}
$(\langle a_1, \ldots, a_n \rangle, \ast) \mapsto \langle a_1', \ldots, a_k' \rangle \in 
(\dagger A \otimes \mathit{merge}_{\mbf{1}};\mathit{merge}_{A,\mbf{1}};\dagger r)$ & iff \\
$\exists m \in \mathbb N.~(\langle a_1, \ldots, a_n \rangle, \langle \ast \rangle^m) \mapsto \langle a_1', \ldots, a_k' \rangle \in 
(\mathit{merge}_{A,\mbf{1}};\dagger r)$ & iff \\
$(\langle a_1,\ldots,a_n\rangle,\langle \ast \rangle^n) \mapsto \langle a_1', \ldots, a_k' \rangle \in (\mathit{merge}_{A,\mbf{1}};\dagger r)$ & iff \\
$\langle (a_1,\ast),\ldots,(a_n,\ast) \rangle \mapsto \langle a_1', \ldots, a_k' \rangle \in \dagger r$ & iff \\
$(k = n) \wedge (a_1 = a_1') \wedge \cdots \wedge (a_n = a_n')$ & iff \\
$(\langle a_1, \ldots, a_n \rangle, \ast) \mapsto \langle a_1', \ldots, a_k' \rangle \in r$ & ~
\end{tabular}
 
\end{proof}


\begin{lemma}
Let $A$,$B$, and $C$ be coherence spaces. Then 
$$\dagger A \otimes (\dagger B \otimes \dagger C) \overset{\dagger A \otimes \mathit{merge}_{B,C}}{\longrightarrow} \dagger A \otimes \dagger(B \otimes C) \overset{\mathit{merge}_{A,B \otimes C}}{\longrightarrow} \dagger(A \otimes (B \otimes C)) \overset{\dagger a_{A,B,C}}{\longrightarrow} \dagger((A \otimes B) \otimes C)$$
$$\text{is equal to}$$ 
$$\dagger A \otimes (\dagger B \otimes \dagger C) \overset{a_{\dagger A, \dagger B, \dagger C}}{\longrightarrow} (\dagger A \otimes \dagger B) \otimes \dagger C \overset{\mathit{merge_{A,B} \otimes \dagger C}}{\longrightarrow} \dagger (A \otimes B) \otimes \dagger C \overset{\mathit{merge}_{A \otimes B,C}}{\longrightarrow} \dagger((A \otimes B) \otimes C)$$
\end{lemma}

\begin{proof}~\\~\\
$(\langle a_1, \ldots, a_n \rangle, (\langle b_1,\ldots,b_m\rangle,\langle c_1,\ldots,c_k\rangle)) 
\mapsto \langle ((a_1',b_1'),c_1') \ldots ((a_l',b_l'),c_l') \rangle$ \\
$\in (\dagger A \otimes \mathit{merge}_{B,C});\mathit{merge}_{A,B \otimes C};\dagger a_{A,B,C}$\\~\\
iff\\~\\
$m=k \wedge (\langle a_1, \ldots, a_n \rangle,\langle (b_1,c_1),\ldots,(b_m,c_m) \rangle) \mapsto
\langle ((a_1',b_1'),c_1'),\ldots,((a_l',b_l'),c_l') \rangle$\\
$\in \mathit{merge}_{A,B \otimes C};\dagger a_{A,B,C}$\\~\\
iff\\~\\
$m=k=n \wedge \langle (a_1,(b_1,c_1)) \ldots (a_n,(b_n,c_n)) \rangle \mapsto \langle ((a_1',b_1'),c_1'),\ldots,((a_l',b_l'),c_l') \rangle$\\
$\in \dagger a_{A,B,C}$\\~\\
iff\\~\\
$m=k=n=l \wedge (a_1 = a_1'),\ldots,(a_n = a_n'),(b_1 = b_1'),\ldots,(b_n = b_n'),(c_1 = c_1'),\ldots,(c_n = c_n')$\\~\\
iff... TODO

\end{proof}

\begin{lemma}
Let $A$ and $B$ be coherence spaces. THen
$$\dagger A \otimes \dagger B \overset{\mathit{merge}_{A,B}}{\longrightarrow} \dagger(A \otimes B) \overset{\dagger s_{A,B}}{\longrightarrow} \dagger (B \otimes A)$$
is equal to 
$$\dagger A \otimes \dagger B \overset{s_{\dagger A,\dagger B}}{\longrightarrow} \dagger B \otimes \dagger A 
\overset{\mathit{merge}_{B,A}}{\longrightarrow} \dagger (B \otimes A)$$
\end{lemma}

\begin{proof}
TODO
\end{proof}

\subsection*{$\dagger$-coalgebras}

We now consider $\dagger$-coalgebra $\alpha : A \to \dagger A$. As objects of $\mathcal {EM}(\dagger)$,
they must make the following diagrams commute:

\begin{mathpar}
\begin{tikzcd}
\dagger A \ar[r, "\mathit{read}_A"] & A \\
A \ar[ur,double,equal] \ar[u,"\alpha"] & 
\end{tikzcd}
\and
\begin{tikzcd}
\dagger A \ar[r,"\mathit{dup}_A"] & \dagger \dagger A \\
A \ar[r,"\alpha" below] \ar[u,"\alpha"] & \dagger A \ar[u,"\dagger \alpha" right]
\end{tikzcd}
\end{mathpar}

Intuitively, such a coalgebra $\alpha$ maps a state $x \in A$ to the active point $\alpha(a) \in \dagger A$ representing all traces with starting state $x$. The left diagram says $\alpha;\mathit{read}_A = id_A$. This means that whenever $(a, \langle a' \rangle) \in \alpha$ we have $a = a'$, which fits perfectly with our intuition.

The right diagram says that $\alpha;\mathit{dup}_A = \alpha;\dagger \alpha$. This means that a token mapping
$$a_1 \overset{\alpha}{\mapsto} \langle a_1, \ldots, a_n \rangle \overset{\dagger \alpha}{\mapsto} 
\langle \langle a_1 = a_{11},\ldots,a_{1m_1} \rangle \ldots, \langle a_n = a_{n1},\ldots,a_{nm_n}\rangle \rangle$$
can be obtained ``directly'' as 
$$a_1 \overset{\alpha}{\mapsto} \langle a_1 = a_{11},a_{12},\ldots,a_{1m_1},\ldots,a_{n1},\ldots,a_{nm_n} \rangle$$

Reddy is not speaking of arbitrary objects of this EM category, but instead limiting his focus to 
``free coalgebras'' whose carriers have the form $\dagger A$ and whose structure maps are comultiplication arrows.
(Comultiplication being a coalgebra of its own comonad is not specific to our category; 
it's a general phenomenon.) 
It's clear coalgebra morphisms between these free coalgebras correspond to regular maps.
\begin{center}
\begin{tikzcd}
\dagger \dagger A \ar[r,"\dagger f"] & \dagger \dagger B \\
\dagger A \ar[u,"\mathit{dup}_A"] \ar[r,"f" below] & \dagger B \ar[u,"\mathit{dup}_B" right] 
\end{tikzcd}
\end{center}

Now let's consider the natural isomorphism $\mbf{C}^\dagger(C,\dagger A) \cong \mbf{C}(UC,A)$. Note that
$\dagger A$ here is being used as shorthand for the coalgebra 
$\dagger A \overset{\mathit{dup}_A}{\longrightarrow} \dagger \dagger A$ and $C$ is shorthand for some $C \overset{h_C}{\longrightarrow} \dagger C \in \mathbf{C}^\dagger$. Given $f \in \mbf{C}(UC,A)$ we obtain a coalgebra morphism
$h_c;\dagger f : C \to \dagger A$. To show that the coalgebra morphism square commutes we have\\~\\
\begin{tabular}{ll}
$(h_c;\dagger f);\mathit{dup}_A$ & ~ \\
$= h_c;\mathit{dup}_A;\dagger \dagger f$ & (naturality)  \\
$= h_c;\dagger h_c;\dagger \dagger f$ & (Eilenberg-Moore square $\alpha;\delta = \alpha;\dagger\alpha$) \\
$= h_c;\dagger(h_c;\dagger f)$ & (functoriality)
\end{tabular}

While the above works for any comonad coalgebra $C \overset{h_C}{\longrightarrow} \dagger C$, it only matches with the description of regular extensions in Section 4 if $C$ is actually a free coalgebra.

Again, mapping through the adjunction in the other direction only corresponds to taking a regular function's linear pattern when the domain is a free coalgebra. It's not hard to see that 
we can take a regular map, i.e. a map of the form 
$\dagger C \overset{g}{\to} \dagger A$ in $\mathbf{C}^{\dagger}_1$ to 
its linear pattern $$\check{g} \doteq U \! \dagger \! C \overset{Ug}{\longrightarrow} U \! \dagger \! A \overset{\mathit{read}_A}{\longrightarrow} A \in \mbf{C}_1$$ The existence of this 
transformation explains why regular maps are defined entirely by their restrictions to singletons 
(which are essentially their pattern maps.) 

I think the transformation $\mathit{discard}_C$ is used by (Id) rule in the following way. Since $- \otimes -$ is
a bifunctor, we can apply it to a vector of arrows which are all components of the $\mathit{discard}$ natural transformation, except in the position of the variable being used, where we use the $\mathit{id}$ arrow:\\~\\
$\sem{x_1:\theta_1,\ldots,x_n:\theta_n \mid x_{n+1} : \theta_{n+1},\ldots,x_{n+m} : \theta_{n+m},y : \theta \vdash y : \theta} \doteq$\\
$\mathit{disc}_{\dagger \sem{\theta_1}} \otimes \ldots \otimes \mathit{disc}_{\dagger \sem{\theta_{n + m}}} \otimes \mathit{id}_{\dagger \sem{\theta}};l;\ldots;l
: \dagger \sem{\theta_1} \otimes \ldots \otimes \dagger \sem{\theta_{n+m}} \otimes \dagger \sem{\theta} \to \dagger \sem{\theta}$

\subsection*{Kleisli Multicategory}

Arrows of the form $\dagger A_1 \otimes \cdots \otimes \dagger A_n \to B$ of our SMCC $\mbf{C}$ form a multicategory, what Reddy calls a ``Kleisli multicategory''. Figure \ref{fig:multicomp} concretely demonstrates the composition of arrows $\dagger A_{11} \otimes \cdots \otimes A_{1n} \overset{f_1}{\to} B_1$ and $\dagger A_{21} \otimes \cdots \otimes \dagger A_{2m} \overset{f_2}{\to} B_2$ into $\dagger B_1 \otimes \dagger B_2 \overset{g}{\to} C$.

\begin{figure}
\begin{tikzcd}
\dagger A_{11} \otimes \cdots \otimes \dagger A_{1n} \otimes \dagger A_{21} \otimes \cdots \dagger A_{2m} 
\ar[d,"\mathit{dup} \otimes \cdots \otimes \mathit{dup}"] \\
\dagger \dagger A_{11} \otimes \cdots \otimes \dagger \dagger A_{1n} \otimes \dagger \dagger A_{21} \otimes \cdots \dagger \dagger A_{2m} \ar[d,"a"] \\
(\dagger \dagger A_{11} \otimes \cdots \otimes \dagger \dagger A_{1n}) \otimes (\dagger \dagger A_{21} \otimes \cdots \dagger \dagger A_{2m}) \ar[d,"\mathit{merge} \otimes \mathit{merge}"]  \\
\dagger (\dagger A_{11} \otimes \cdots \otimes \dagger A_{1n}) \otimes \dagger (\dagger A_{21} \otimes \cdots \dagger A_{2m}) \ar[d,"(\dagger f_1) \otimes (\dagger f_2)"] \\
\dagger B_1 \otimes \dagger B_2 \ar[d,"g"] \\
C  
\end{tikzcd}
\caption{Semi-formal demonstration of Kleisli multicategory composition}
\label{fig:multicomp}
\end{figure}

\subsection*{Passivity reflection}

The codomain of $\wp$ and $\mathcal P$ was written incorrectly: it should be $\wp, \mathcal P : \mbf{C} \to \mbf{P}$. $\wp$ converts an arbitrary
active-passive space to a passive space by throwing away the active tokens and restricting linear functions to active points. $\mathcal P$ pretends that an active-passive space's active tokens are actually passive, and leaves linear functions unchanged.

For a discussion of reflections, see MiscStudy pg 6822. For $\wp$ we have the following situation:

\begin{center}
\begin{tikzcd}
\wp \ar[r,"f^{\flat}"] A & P \\
A \ar[u,"\mathit{pas}_A"] \ar[ur,"f" below] & ~ \\
\end{tikzcd}
\\
\begin{tikzcd}
\wp A \ar[r,"f^{\flat}"] \ar[dr,"\wp f~~~~~" below] & P \\
 ~ & \wp P \ar[u,equal,double]
\end{tikzcd}
\end{center}

The linear function $\mathit{pas}_A : A \to_L \wp A$ maps each point to its subset of passive tokens.
Equivalently, we can define it as a set of tokens:
$$\mathit{pas}_A \doteq \{ a \mapsto a \mid a \in |A|_{\wp} \}$$

\begin{lemma}
Let $A$ be an active-passive space, $P$ a passive space, and $f : A \to_L P$ a passivity preserving linear function. Then $\mathit{pas}_A;\wp f = f$. 
\end{lemma}

\begin{proof}
Obvious.
\end{proof}

Now let's examine the $\mathit{Activate}$ and $\mathit{Passify}$ typing rules.

\begin{mathpar}
\inferrule[Activate]
  {\Pi,x:\theta \mid \Gamma \vdash P : \theta'}
  {\Pi \mid \Gamma,x:\theta \vdash P : \theta'}
\and
\inferrule[Passify]
  {\Pi \mid \Gamma,x:\theta \vdash P : \phi}
  {\Pi,x:\theta \mid \Gamma \vdash P : \phi}
\end{mathpar}

In the \begin{sc} Activate \end{sc} rule, we interpret the hypothesis as a multi-arrow
$$\dagger \wp \sem{\theta_1} \otimes \cdots \otimes \dagger \wp \sem{\theta_n} \otimes \dagger \wp \sem{\theta} \otimes \dagger \sem{\theta_{n+1}} \otimes \cdots \otimes \dagger \sem{\theta_{n+m}} \overset{\sem{\Pi \mid \Gamma, x:\theta \vdash P : \theta'}}{\longrightarrow} \sem{\theta'}$$
To obntain our conclusion, we must precompose this arrow with another arrow:
\begin{center}
\begin{tikzcd}
\dagger \wp \sem{\theta_1} \otimes \cdots \otimes \dagger \wp \sem{\theta_n} \otimes \dagger \sem{\theta_{n+1}} \otimes \cdots \otimes \dagger \sem{\theta_{n+m}} \otimes \dagger \sem{\theta}  \ar [d] \\  
\dagger \wp \sem{\theta_1} \otimes \cdots \otimes \dagger \wp \sem{\theta_n} \otimes \dagger \wp \sem{\theta} \otimes \dagger \sem{\theta_{n+1}} \otimes \cdots \otimes \dagger \sem{\theta_{n+m}}
\end{tikzcd}
\end{center}
Sans some SMCC-fu, this essentially boils down to an arrow $\dagger \sem{\theta} \to \dagger \wp \sem{\theta}$,
for which we use $\dagger \mathit{pas}_{\sem{\theta}}$.

The key to understanding the \begin{sc} Passify \end{sc} rule is that the $\wp$ functor distributes over
tensor product and commutes with $\dagger -$. So given an interpretation of the hypothesis $$\dagger \wp \sem{\theta_1} \otimes \cdots \otimes \dagger \wp \sem{\theta_n} \otimes \dagger \sem{\theta_{n+1}} \otimes \cdots \otimes \dagger \sem{\theta_{n+m}} \otimes \dagger \sem{\theta} \to \sem{\phi}$$
we apply $\wp$ to obtain
$$\dagger \wp \sem{\theta_1} \otimes \cdots \otimes \dagger \wp \sem{\theta_n} \otimes \dagger \wp \sem{\theta_{n+1}} \otimes \cdots \otimes \dagger \wp \sem{\theta_{n+m}} \otimes \dagger \wp \sem{\theta} \to \wp \sem{\phi} = \sem{\phi}$$

Then, along with some additional SMCC-fu, we can use the $\mathit{pas}$ transformation to activate the incidentally-pasified components $\theta_{n+1} \ldots, \theta_{n+m}$, obtaining the interpretation of the conclusion of 
\begin{sc} Passify \end{sc}. 

\subsection*{Passivity coreflection}

Let $P$ be a passive space, $B$ an active-passive space, and $f : P \to_L B$ a passivity reflecting linear function. The coreflection for $\mathcal P$ is depicted as follows
\begin{center}
\begin{tikzcd}
\mathcal P P \ar[r,"\mathcal P f"] & \mathcal B \\
P \ar[ur,"~f^{\flat}" below] \ar[u,double,equal] & ~ \\
~ & ~
\end{tikzcd}~\\
\begin{tikzcd}
P \ar[r,"f" above] \ar[dr, "\mathcal P f~~~" below] & B \\
 ~ & \mathcal P B \ar[u, "\mathit{der}_B" right]  
\end{tikzcd}~\\
\end{center}
Reddy defines $\mathit{der}_B$ as the set of tokens $\{ b \mapsto b \mid b \in |B| \}$.
\begin{lemma}
Let $P$ be a passive space, $B$ an active-passive space, and $f : P \to_L B$ a passivity reflecting linear map. 
Then $\mathcal Pf;\mathit{der}_B = f$.
\end{lemma}

\begin{proof}
Obvious.
\end{proof}~\\
Now let's examine the \smc{(Promote)} and \smc{(Derelict)} rules.

\begin{mathpar}
\inferrule[Promote]
  {\Pi \mid ~ \vdash P : \theta_1 \to \theta_2}
  {\Pi \mid ~ \vdash P : \theta_1 \to_p \theta_2}
\and
\inferrule[Derelict]
  {\Pi \mid \Gamma \vdash P : \theta_1 \to_P \theta_2}
  {\Pi \mid \Gamma \vdash P : \theta_1 \to \theta_2}
\end{mathpar}

\end{document}



