\documentclass{article}
 
\usepackage{amscd}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{stmaryrd}
\usepackage{mathpartir}
\usepackage{multicol}
\usepackage{enumitem}
\usepackage[section]{placeins} % float barriers
\usepackage{natbib}
\usepackage{xcolor} 
\usepackage{bussproofs} 
\usepackage{diagrams}
\usepackage{tikz}
\usepackage{tabu}
\usepackage{quiver} 
\usepackage{stackengine}

\usetikzlibrary{cd}
 
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{remark}{Remark}

%example: \limit{j \in J}{F_j}
\newcommand{\limit}[2]{\underset{\overset{\longleftarrow}{#1}}{\text{lim}}~#2}
\newcommand{\lims}[1]{\underset{\longleftarrow}{\text{lim}}~#1}
\newcommand{\mbf}{\mathbf}
\newcommand{\sem}[1]{\llbracket #1 \rrbracket}
\newcommand{\defeq}{\overset{\mathit{def}}{=}}
\newcommand{\capdot}{~\stackinset{c}{}{c}{}{\scalebox{0.8}{$\ast$}}{$\cap$}~}
\newcommand{\bigcapdot}{\mathop{\stackinset{c}{}{c}{}{\scalebox{0.8}{$\ast$}}{$\bigcap$}}}
\newcommand{\scdots}{\scalebox{0.6}{$\cdots$}}

\newcommand{\vrt}[2]{
\pile{
#1 \\
\downarrow \\
#2
}
}

\newcommand{\sdisp}[1]{
\left( #1 \right)
}

\newcommand{\ddisp}[3]{
\left(
\scriptsize
\begin{tikzcd}
#1 \ar[d, "\footnotesize{#2}"] \\
#3
\end{tikzcd}
\normalsize
\right)
}

\newcommand{\disp}[3]{
\left(
\tiny
\begin{array}{c}
#1 \\
\downarrow\\
#3
\end{array}
\begin{array}{l}
~ \\
#2 \\
~
\end{array}
\normalsize
\right)
}

\newcommand{\dispp}[3]{
\tiny
\begin{tikzcd}
#1 \ar[d, "#2"] \\
#3
\end{tikzcd}
\normalsize
}

% give tables some extra space between rows and columns
\renewcommand{\arraystretch}{1.4}

\title{Schema Type Calculus}

\begin{document}

\maketitle

\section*{Syntax}

\begin{tabular}{llll}
$\mathit{Chars}$ & $\doteq$ & the set of all characters \\
$\mathit{TypeVars}$ & $\doteq$ & the set of all type variables \\
$\mathit{StringVars}$ & $\doteq$ & the set of all string variables \\
$\alpha$ & $\in$ & $\mathit{TypeVars}$ & ~ \\
$\zeta,\xi$ & $\in$ & $\mathit{StringVars}$ & ~ \\
$c$ & $\in$ & $\mathit{Chars}$ & (characters) \\
$\phi$ & $\in$ & $\mathcal P(\mathit{Chars})$ & (subsets of the set of characters) \\
$s,t$ & $\in$ & $\mathit{Strings}$ & (where $\mathit{Strings} = \mathit{Chars}^{\star}$) \\~\\
$S,T$ (string index) & $::=$ & $s$ & (literal string) \\
                   & $\mid$ & $\zeta$ & (string variable) \\~\\
$d$ (discriminator) & $::=$  & $\mathit{Prefix}~S$ & (values that begin with $S$) \\
    & $\mid$ & $\mathit{Literal}~S$ & (values that are equal to $S$) \\
 & & \\
$m$ (multiplicity) & $::=$ & $\mathit{one} \mid \mathit{set} \mid \mathit{opt}$\\~\\
$\tau$ (type) & $::=$ & $\mathit{tuple} \{ s_i : \tau_i : c_i^{~i \in 1..n} \}$ & (pieced string) \\
       & $\mid$ & $s$ & (string literal type) \\
       & $\mid$ & $(S_1,\ldots,S_n).[\phi]$ & (path type) \\
       & $\mid$ & $\biguplus \tau_i^{~i \in 1..n}$ & (union of disjoint types) \\ 
       & $\mid$ & $\tau.\{[\tau_i] :^{m_i} \tau_i'~^{i \in 1..n}\}$ & (record type - $\mathit{root}.\{ fields \}$) \\ 
       & $\mid$ & $\lambda (\alpha :: \kappa). \tau$ & (type abstraction) \\
       & $\mid$ & $\lambda \zeta. \tau$ & (index abstraction) \\
       & $\mid$ & $\tau~[S]$ & (index application) \\
       & $\mid$ & $\tau~\tau$ & (type application) \\
       & $\mid$ & $\alpha$ & (type variable) \\~\\
$\kappa, \iota$ (kind) & $::=$ & $\mathit{KString}(d,\phi)$ & (Kind of string types, chars drawn from $\phi$) \\
                       & $\mid$ & $\mathit{KTree}(d)$ & (Kind of tree types w/ root discriminator $d$) \\
                       & $\mid$ & $\kappa \overset{A}{\Rightarrow} \kappa$ & (Kind of type abstractions) \\
                       & $\mid$ & $\forall \zeta. \kappa$ & (Kind of string abstractions) \\~\\
\end{tabular}\\~\\~\\
\begin{tabular}{llll}
$\Sigma$ (index context) & $::=$ & $\Sigma,\zeta$ & (context extension) \\
                         & $\mid$ & $\emptyset$ & (empty context) \\~\\
$\Gamma$ (kind context) & $::=$ & $\Gamma,x :: \kappa$ & (context extension) \\
                           & $\mid$ & $\emptyset$ & (empty context) \\~\\
$q$ (coeffect constraint)  & $::=$ & $(S_1,\ldots,S_n).[\phi]$ & ~ \\~\\ 
$A$ (coeffect) & $\subseteq$ & $q$ & ~ 
\end{tabular}

\section*{Index contexts}

All index variables $\zeta$ have the same interpretation, as the set of all strings: $\sem{\zeta} \defeq \mathit{Strings}$.

An index context is interpreted inductively as a set: $\sem{\Sigma,\zeta} \defeq \sem{\Sigma} \times \sem{\zeta}$ and $\sem{\emptyset} \defeq 1$ where $1$ is a singleton set $\{ \ast \}$. We will often treat an element of an index context $\sigma \in \sem{\zeta_1,\ldots,\zeta_n}$ as a function from the set of index variables $\{ \zeta_1, \ldots, \zeta_n \}$ to the set $\mathit{Strings}$, writing $\sigma(\zeta_i)$ for the projection of $\sigma$'s component corresponding to $\zeta_i$. 

\section*{Index well-formedness}

\begin{mathpar}
\inferrule[IWF-Var]
  {\zeta \in \Sigma}
  {\Sigma \vdash \zeta}
\and
\inferrule[IWF-Lit]
  {~}
  {\Sigma \vdash s}
\end{mathpar}
The interpretation $\sem{\Sigma \vdash S}$ of a well-formed index judgment is a $\sem{\Sigma}$-indexed family of strings, i.e., viewing the set $\mathit{Strings}$ as a discrete category, it is an object of $\mathit{Fam}(\mathit{Strings})_{\sem{\Sigma}}$ defined as follows:
\begin{mathpar}
\sem{\Sigma \vdash \zeta} \doteq (\sigma(\zeta))_{\sigma \in \sem{\Sigma}}
\and
\sem{\Sigma \vdash s} \doteq (s)_{\sigma \in \sem{\Sigma}}
\end{mathpar}

\section*{Discriminator well-formedness}

\begin{mathpar}
\inferrule[DWF-Prefix]
  {\Sigma \vdash S}
  {\Sigma \vdash \mathit{Prefix}~S}
\and
\inferrule[DWF-Lit]
  {\Sigma \vdash S}
  {\Sigma \vdash \mathit{Literal}~S}
\end{mathpar}

The interpretation $\sem{\Sigma \vdash d}$ of a discriminator well-formedness judgment is a $\sem{\Sigma}$-indexed family of sets of strings, i.e., viewing $\mathcal P(\mathit{Strings})$ as a thin category ordered by set inclusion, $\sem{\Sigma \vdash d}$ is an object of $\mathit{Fam}(\mathcal P(\mathit{Strings}))_{\sem{\Sigma}}$. 
\begin{mathpar}
\sem{\Sigma \vdash \mathit{Prefix}~S} \defeq (\{ t \mid \sem{\Sigma \vdash S}_\sigma \text{ is a prefix of } t \})_{\sigma \in \sem{\Sigma}}
\and
\sem{\Sigma \vdash \mathit{Literal}~S} \defeq (\{ \sem{\Sigma \vdash S}_\sigma \})_{\sigma \in \sem{\Sigma}}
\end{mathpar}

For $A,B \in \mathcal P(\mathit{Strings})$, there is at most one arrow (set inclusion) with domain $A$ and 
codomain $B$; we write this arrow as $i_{A,B}$.


\section*{Discriminator subsumption}

\begin{mathpar}
\inferrule[SD-PrefPref]
  {s' \sqsubseteq s}
  {\Sigma \vdash \mathit{Prefix}~s \leq \mathit{Prefix}~s'}
\and
\inferrule[SD-LitLit]
  {\Sigma \vdash S}
  {\Sigma \vdash \mathit{Literal}~S \leq \mathit{Literal}~S}
\and
\inferrule[SD-LitPref]
  {s' \sqsubseteq s}
  {\Sigma \vdash \mathit{Literal}~s \leq \mathit{Prefix}~s'}
\and
\end{mathpar}

Above, $s' \sqsubseteq s$ means ``$s'$ is a prefix of $s$''. 
The interpretation $\sem{\Sigma \vdash d \leq d'}$ of a subsumption judgment is an arrow of $\mathit{Fam}(\mathcal P(\mathit{Strings}))_{\sem{\Sigma}}$ with domain $\sem{\Sigma \vdash d}$ and codomain $\sem{\Sigma \vdash d'}$. 

\section*{Discriminator disjointness}

We introduce a system for proving \emph{discriminator disjointness judgments} of the form $\Sigma \vdash \mbf{disj}~d_1~d_2$:
\begin{mathpar}
\inferrule
  {s \neq t}
  {\Sigma \vdash \mbf{disj}~(\mathit{DLiteral}~s)~(\mathit{DLiteral}~t)}
\and
\inferrule
  {s \not \sqsubseteq t \\ t \not \sqsubseteq s}
  {\Sigma \vdash \mbf{disj}~(\mathit{DPrefix}~s)~(\mathit{DPrefix}~t)}
\and
\inferrule
  {s \not \sqsubseteq t}
  {\Sigma \vdash \mbf{disj}~(\mathit{DPrefix}~s)~(\mathit{DLiteral}~t)}
\and
\inferrule
  {s \not \sqsubseteq t}
  {\Sigma \vdash \mbf{disj}~(\mathit{DLiteral}~t)~(\mathit{DPrefix}~s)}
\end{mathpar}
Here $s \not \sqsubseteq t$ means ``$s$ is not a prefix of $t$''. A judgment $\Sigma \vdash \mathbf{disj}~d_1~d_2$ is interpreted in the obvious way as a family $(p_\sigma)_{\sigma \in \Sigma}$, where for $\sigma \in \Sigma$, $p_\sigma$ is a proof that $\sem{\Sigma \vdash d_1}_\sigma \cap \sem{\Sigma \vdash d_2}_\sigma = \emptyset$. 


\section*{Multiplicities}

A multiplicity is intepreted as a subset of $\mathbb N$.\\~\\
\begin{tabular}{lll}
$\sem{one}$ & $\defeq$ & $\{ 1 \}$ \\
$\sem{opt}$ & $\defeq$ & $\{ 0, 1 \}$ \\
$\sem{set}$ & $\defeq$ & $\mathbb N$
\end{tabular}
\section*{Database instances}

Given lists of strings $\rho$ and $\theta$, we write $\rho \cdot \theta$ for the list obtained by concatenating $\theta$ to the right of $\rho$. A \emph{database instance} is a partial function from lists of strings to strings. We write $\mathit{Inst}$ for the set of database instances. For a database instance $f$ and a list of strings $\rho$, we write $f \! \mid_\rho$ for the database instance defined such that for all lists of strings $\theta$ we have $$f \! \mid_\rho \! (\theta) \defeq f(\rho \cdot \theta)$$ We call a list of strings a \emph{node}. We say that database $f$ is \emph{active} at node $\rho$, written $a \downarrow \downarrow \rho$, if $f \! \mid_\rho$ is defined somewhere. We write the list of strings consisting of $s_1, \ldots, s_n$ as $[s_1,\ldots,s_n]$. For database instances $f$ we define the notation $$\mathit{keys}(f) \defeq \{ s \in \mathit{Strings} \mid f \text{ is active at } [s] \}$$ Furthermore, for sets of strings $X$ we define
$$f \# X \defeq | \mathit{keys}(f) \cap X |$$ 


\section*{Coeffect Well-formedness}

The judgment $\Sigma \vdash A$ means that the coeffect $A$ is well-formed under index context $\Sigma$,
in the sense that for each $(S_1,\ldots,S_n).[\phi] \in A$ we have $\Sigma \vdash S_i^{~i \in 1..n}$.

The interpretation $\sem{\Sigma \vdash A}$ is a $\sem{\Sigma}$-indexed family of posets of database instances, defined as $$\sem{\Sigma \vdash A} \defeq (I_\sigma, \leq_\sigma)_{\sigma \in \sem{\Sigma}}$$ where $$I_\sigma \defeq \sdisp{\bigcap_{(S_1,\ldots,S_n).[\phi] \in A} \{ f \in \mathit{Inst} \mid \forall s \in \mathit{keys}(f \! \mid_{[\sem{\Sigma \vdash S_1}_\sigma, \ldots, \sem{\Sigma \vdash S_n}_\sigma]}).~\mathit{chars}(s) \subseteq \phi \}}_{\sigma \in \sem{\Sigma}}$$ and for $f,g \in I_{\sigma}$ we have
$$f \leq_\sigma g \overset{\mathit{def}}{\Leftrightarrow} (\forall \rho \in \mathit{Strings}^\star.~f(\rho) \text{ is defined} \Rightarrow g(\rho) \text{ is defined})$$
 
\section*{Coeffect composition}

For all $\Sigma$ and all $A$ and $B$ with $\Sigma \vdash A$ and $\Sigma \vdash B$ we define $A \capdot B$ as\\~\\
$(A - B)~\cup~(B - A)~\cup$\\
$\{ (S_1,\ldots,S_n).[\phi_1 \cap \phi_2] \mid (S_1,\ldots,S_n).[\phi_1] \in A \wedge (S_1,\ldots,S_n).[\phi_2] \in B \}$ \\~\\
Clearly, $\Sigma \vdash A$ and $\Sigma \vdash B$ implies $\Sigma \vdash A \capdot B$. 
\section*{Fibred graded comonads}
 
For each $\Sigma$, we define a graded comonad $D_{\Sigma}$ on the category $\mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$ of $\sem{\Sigma}$-indexed families of posets. The scalar coeffect structure is $$( \{ A \mid \text{the judgment } \Sigma \vdash A \text{ is provable} \}, \capdot, \capdot, \emptyset, \emptyset, \subseteq)$$ For objects $(X_\sigma)_{\sigma \in \sem{\Sigma}}$ of the fibre $\mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$, we define $$D_{\Sigma} A(~(X_\sigma)_{\sigma \in \sem{\Sigma}}~) \defeq (X_\sigma \times \sem{\Sigma \vdash A}_\sigma)_{\sigma \in \sem{\Sigma}}$$ For arrows $(f_\sigma : X_\sigma \to Y_\sigma)_{\sigma \in \sem{\Sigma}}$ of the fibre $\mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$ we define $$D_{\Sigma} A(~(f_\sigma)_{\sigma \in \sem{\Sigma}}~) \defeq (~(x_\sigma, a_\sigma) \mapsto (f_\sigma(x_\sigma),a_\sigma)~)_{\sigma \in \sem{\Sigma}}$$ Its counit $\epsilon$ is defined as $$(\epsilon_{\emptyset})_X \defeq (x,a) \mapsto x
$$ Its comultiplication $\delta$, for coeffect scalars $A$ and $B$, is defined as $$(\delta_{A,B})_X \defeq (x,a \capdot b) \mapsto ((x, a), b)$$ 
It's easy to see that $(D_{\Sigma}, \epsilon, \delta)$ forms a graded comonad. The following diagram commutes because duplication followed by projection is the identity.

\[\begin{tikzcd}
	{D_{\Sigma} A} && {(D_{\Sigma} A) \circ (D_{\Sigma} \emptyset)} \\
	\\
	{(D_{\Sigma} \emptyset) \circ (D_{\Sigma} A)} && {D_{\Sigma} A}
	\arrow["{\delta_{\empty,A}}"', from=1-1, to=3-1]
	\arrow["{\epsilon_{\emptyset} \circ (D_{\Sigma} A)}"', from=3-1, to=3-3]
	\arrow["{\delta_{A, \emptyset}}", from=1-1, to=1-3]
	\arrow["{(D_{\Sigma} A) \circ \epsilon_{\emptyset}}", from=1-3, to=3-3]
	\arrow[no head, equals, from=1-1, to=3-3]
\end{tikzcd}\]
And the following diagram commutes because duplicating an object twice is the same as duplicating and then duplicating the duplicate.

\[\begin{tikzcd}
	{(D_{\Sigma}~A \capdot B \capdot C)} && {(D_{\Sigma}~A \capdot B) \circ (D_{\Sigma} C)} \\
	\\
	{(D_{\Sigma} A) \circ (D_{\Sigma}~B \capdot C)} && {(D_{\Sigma} A) \circ (D_{\Sigma} B) \circ (D_{\Sigma} C)}
	\arrow["{\delta_{A, B \capdot C}}"', from=1-1, to=3-1]
	\arrow["{D_{\Sigma} A \circ \delta_{B,C}}"', from=3-1, to=3-3]
	\arrow["{\delta_{A \bullet B, C}}", from=1-1, to=1-3]
	\arrow["{\delta_{A,B} \circ D_{\Sigma} C}", from=1-3, to=3-3]
\end{tikzcd}\]

For string contexts $\Sigma$ and coeffect scalars $\Sigma \vdash A$ and $\Sigma \vdash B$ with $A \subseteq B$ we have a natural transformation $\mathit{sub}_{A,B} : D_{\Sigma} B \to D_{\Sigma } A$, defined at component $X \in \mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$ as the family of monotone functions $$(~(x,b) \mapsto (x,b) : X_\sigma \times \sem{\Sigma \vdash B}_\sigma \to X_{\sigma} \times \sem{\Sigma \vdash A}_{\sigma}~)_{\sigma \in \sem{\Sigma}}$$
which is an arrow in $\mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$ of type $$D_{\Sigma}B(X) \to D_{\Sigma}A(X)$$
For coeffect scalars $\Sigma \vdash A$ and kinding contexts $\Sigma \vdash \Gamma,x :: \kappa$, we have a natural isomorphism $$m_{\Sigma,A,\Gamma,\kappa} : D_{\Sigma} \emptyset(\sem{\Sigma \vdash \Gamma}) \times D_{\Sigma} A( \sem{\Sigma \vdash \kappa} ) \overset{\sim}{\to} D_{\Sigma} A \sem{\Sigma \vdash \Gamma,x :: \kappa}$$ defined to discard the copy of $\sem{\Sigma \vdash \emptyset}$ produced by applying $D_{\Sigma} \emptyset$ and then reassociate.

\section*{Substitution Functors}

Given a category $\mathbb C$ and a function $u : I \to J$, we write $u^* : \mathit{Fam}(\mbf{\mathbb C})_J \to \mathit{Fam}(\mathbb C)_I$ for the substitution functor induced by $u$; i.e., for an $J$-indexed family of $\mathbb C$-objects $\sdisp{P_j}_{j \in J}$ we have $$u^* (\sdisp{P_j}_{j \in J}) = \sdisp{ P_{u(i)} }_{i \in I}$$ and for a $J$-indexed family of $\mathbb C$-arrows $(f_j : P_j \to Q_j)_{j \in J}$ we have $$u^*(\sdisp{f_j}_{j \in J}) = \sdisp{f_{u(i)}}_{i \in I}$$

\section*{Simple Products}

In what follows, let $\pi_{\Sigma,\zeta} : \sem{\Sigma,\zeta} \to \sem{\Sigma}$ denote the projection function which discards the mapping entry corresponding to $\zeta$. The category $\mathit{Fam}(\mbf{Posets})$ has \emph{simple products}, meaning that the substitution functor $\pi_{\Sigma,\zeta}^* : \mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}} \to \mathit{Fam}(\mbf{Posets})_{\sem{\Sigma,\zeta}}$ has a right adjoint $\Pi_{\Sigma,\zeta} : \mathit{Fam}(\mbf{Posets})_{\sem{\Sigma,\zeta}} \to \mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$ such that for functions $f : \sem{\Sigma'} \to \sem{\Sigma}$, in the diagram

\[\begin{tikzcd}
	{\mathit{Fam}(\mathbf{Posets})_{\sem{\Sigma}}} && {\mathit{Fam}(\mathbf{Posets})_{\sem{\Sigma'}}} \\
	\\
	{\mathit{Fam}(\mathbf{Posets})_{\sem{\Sigma,\zeta}}} && {\mathit{Fam}(\mathbf{Posets})_{\sem{\Sigma',\zeta}}}
	\arrow["{\pi_{\sem{\Sigma,\zeta}}^* }"', curve={height=18pt}, from=1-1, to=3-1]
	\arrow["{\Pi_{\sem{\Sigma,\zeta}}}"', curve={height=18pt}, from=3-1, to=1-1]
	\arrow["{f^*}", from=1-1, to=1-3]
	\arrow["{(f \times \mathit{id})^*}" below, from=3-1, to=3-3]
	\arrow["{\pi^*_{\sem{\Sigma',\zeta}}}"', curve={height=18pt}, from=1-3, to=3-3]
	\arrow["{\Pi_{\sem{\Sigma',\zeta}}}"', curve={height=18pt}, from=3-3, to=1-3]
\end{tikzcd}\]
the canonical transformation $f^* \Pi_{\sem{\Sigma},\sem{\zeta}} \Rightarrow \Pi_{\sem{\Sigma'},\sem{\zeta}} (f \times \mathit{id})^*$ is an isomorphism.

The \emph{canonical transformation} is obtained as follows. First, from the well known fact that for every fibration and all arrows $u : I \to J, v : J \to K$ of the fibration's base category we have $u^*v^* \cong (u;v)^*$ we obtain $$(f \times \mathit{id})^*\pi^*_{\sem{\Sigma,\zeta}} \cong ((f \times \mathit{id});\pi_{\sem{\Sigma,\zeta}})^* = (\langle \pi_{\Sigma',\zeta} f, \pi'_{\Sigma',\zeta} \mathit{id} \rangle;\pi_{\sem{\Sigma,\zeta}})^* = (\pi_{\Sigma',\zeta};f)^* = \pi_{\sem{\Sigma',\zeta}}^* f^*$$
Then, the canonical transformation is the transpose of 
$$\pi^* f^* \Pi \overset{\cong}{\longrightarrow} (f \times \mathit{id})^* \pi^* \Pi \overset{(f \times \mathit{id})^* \epsilon}{\longrightarrow} (f \times \mathit{id})^*$$

In the specific case of $\mathit{Fam}(\mathbf{Posets})$, for sets $I$ and $J$ we have $\Pi_{(I,J)} : \mathit{Fam}(\mathbf{Posets})_{I \times J} \to \mathit{Fam}(\mathbf{Posets})_I$ equal to the mapping
$$(P_{(i,j)})_{(i,j) \in I \times J} \mapsto (\Pi_{j \in J} P_{(i,j)})_{i \in I}$$  
where for $i \in I$, $\Pi_{j \in J} P_{(i,j)}$ is a $J$-indexed product of posets.

TODO: finish this... some of it can be found in Jacobs Lemma 1.9.2.

\section*{Kind well-formedness}

\begin{mathpar}
\inferrule[KWF-Str]
  {\Sigma \vdash d}
  {\Sigma \vdash \mathit{KString(d,\phi)}}
\and
\inferrule[KWF-Tree]
  {\Sigma \vdash d}
  {\Sigma \vdash \mathit{KTree(d)}}
\and
\inferrule[KWF-TyFun]
  {\Sigma \vdash \kappa \\ \Sigma \vdash \kappa' \\ \Sigma \vdash A}
  {\Sigma \vdash \kappa \overset{A}{\Rightarrow} \kappa'}
\and
\inferrule[KWF-StrFun]
  {\Sigma,\zeta \vdash \kappa}
  {\Sigma \vdash \forall \zeta. \kappa}
\end{mathpar}

The interpretation $\sem{\Sigma \vdash \kappa}$ of a kind well-formedness judgment is a $\sem{\Sigma}$-indexed family of posets, defined as follows.

\begin{tabular}{lll}
$\sem{\Sigma \vdash \mathit{KString}(d,\phi)}$ & $\defeq \sdisp{~(\mathcal P(X_\sigma), \subseteq)~}_{\sigma \in \sem{\Sigma}}$ & $\text{where } X_\sigma \defeq \{~\{ \epsilon \mapsto s \} \in \mathit{Inst} \mid s \in \sem{\Sigma \vdash d}_{\sigma} ~\wedge$ \\
 & &~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~$\mathit{chars}(s) \subseteq \phi \}$ \\
$\sem{\Sigma \vdash \mathit{KTree}(d)}$ & $\defeq \sdisp{~(\mathcal P(Y_\sigma), \subseteq)~}_{\sigma \in \sem{\Sigma}}$ & $\text{where } Y_\sigma \defeq \{ f \in \mathit{Inst} \mid f(\epsilon) \in \sem{\Sigma \vdash d}_{\sigma} \}$ \\
$\sem{\Sigma \vdash \kappa \overset{A}{\Rightarrow} \kappa'}$ & $\defeq D_{\Sigma} A(\sem{\Sigma \vdash \kappa}) \Rightarrow \sem{\Sigma \vdash \kappa'}$\\
$\sem{\Sigma \vdash \forall \zeta. \kappa}$ & $\defeq \Pi_{\sem{\Sigma},\sem{\zeta}} \sem{\Sigma,\zeta \vdash \kappa} $ & 
\end{tabular}

\section*{Subkinding}


\begin{mathpar}
\inferrule[SK-StrTree]
  {\Sigma \vdash d \leq d'}
  {\Sigma \vdash \mathit{KString}(d,\phi) <:: \mathit{KTree}(d')}
\and
\inferrule[SK-StrStr]
  {\Sigma \vdash d \leq d' \\ \phi \subseteq \phi'}
  {\Sigma \vdash \mathit{KString}(d,\phi) <:: \mathit{KString}(d',\phi')}
\and
\inferrule[SK-TreeTree]
  {\Sigma \vdash d \leq d'}
  {\Sigma \vdash \mathit{KTree}(d) <:: \mathit{KTree}(d')}
\end{mathpar}

Abstractly, the interpretation $\sem{\Sigma \vdash \kappa <:: \kappa'}$ is a mono in the fibre $\mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$ from $\sem{\Sigma \vdash \kappa}$ to $\sem{\Sigma \vdash \kappa'}$. 

% TODO: is mono really the right concept above, or is there a suitable factorization system on the Fam(Posets) category that should be used instead?

For discriminators $d$ and $\phi \subseteq \mathit{Chars}$, we have that $\sem{\Sigma \vdash \mathit{KString}(d,\phi)}$ and $\sem{\Sigma \vdash \mathit{KTree}(d)}$ are families of sets. Each judgment $\Sigma \vdash \kappa <:: \kappa'$ above is interpreted as the family of inclusions $(i_{\sem{\Sigma \vdash \kappa}_\sigma,\sem{\Sigma \vdash \kappa'}_\sigma})_{\sigma \in \sem{\Sigma}}$. For example, for \begin{sc}SK-StrTree\end{sc}, our hypothesis is interpreted as a family of inclusions $$(i_{\sem{\Sigma \vdash d}_{\sigma}, \sem{\Sigma \vdash d'}_\sigma})_{\sigma \in \sem{\Sigma}}$$ and we have that $(i_{\sem{\Sigma \vdash \kappa}_\sigma,\sem{\Sigma \vdash \kappa'}_\sigma})_{\sigma \in \sem{\Sigma}}$ exists, because\\~\\
$\sem{\Sigma \vdash \mathit{KString(d,\phi)} <:: \mathit{KTree}(d')}_\sigma$\\
$= \{~\{ \epsilon \mapsto s \} \in \mathit{Inst} \mid s \in \sem{\Sigma \vdash d}_{\sigma} \wedge \mathit{chars}(s) \subseteq \phi \}$\\
$\subseteq \{~\{ \epsilon \mapsto s \} \in \mathit{Inst} \mid s \in \sem{\Sigma \vdash d}_{\sigma} \}$\\
$\subseteq \{~\{ \epsilon \mapsto s \} \in \mathit{Inst} \mid s \in \sem{\Sigma \vdash d'}_{\sigma} \}$\\
$\subseteq \{ f \in \mathit{Inst} \mid f(\epsilon) \in \sem{\Sigma \vdash d'}_{\sigma} \}$

\section*{Kinding}

In what follows, we define $\ast \defeq \mathit{KTree}(\mathit{Prefix}~\epsilon)$, where $\epsilon$ is the empty string, so that all proper types have kind $\ast$. We define $\star \defeq \mathit{KString}(\mathit{Prefix}~\epsilon, \mathit{Chars})$, so that all string types have kind $\star$.

\begin{mathpar}
\inferrule[TyVar]
  {i \in 1..n}
  {\Sigma \mid x_1 :: \kappa_1, \ldots, x_n :: \kappa_n \vdash x_i :: \kappa_i}
\and
\inferrule[Tuple]
  {\Sigma \mid \Gamma@A_i \vdash \tau_i :: \mathit{KString}(d_i,\phi_i)^{~i \in 1..n} \\ 
   c \not \in \phi_i^{~i \in 1..n} }
  {\Sigma \mid \Gamma@(\bigcapdot_{i \in 1..n} A_i) \vdash \mathit{tuple}~c~\{ s_i : \tau_i^{~i \in 1..n}\} :: \mathit{KString}(d_1, (\bigcup_{i \in 1..n} \phi_i) \cup \{ c_1, \ldots, c_n \})}
\and
\inferrule[DisjUnion]
  {\Sigma \mid \Gamma@A_i \vdash \tau_i :: \mathit{KTree}(d_i) \\ \Sigma \vdash \mbf{disj}~d_i~d_j~^{i,j \in 1..n~i \neq j} }
  {\Sigma \mid \Gamma@(\bigcapdot_{i \in 1..n} A_i) \vdash \biguplus_{i \in 1..n} \tau_i :: \mathit{KTree}(\mathit{merge}~\{ d_i^{~i \in 1..n} \})}
\and
\inferrule[Record]
  {\Sigma \mid \Gamma@A \vdash \tau :: \mathit{KString}(d,\phi) \\ 
    \Sigma \mid \Gamma@B_i \vdash \tau_i :: \mathit{KString}(d_i,\phi_i)^{~i \in 1..n} \\
    \Sigma \vdash \mbf{disj}~d_i~d_j~^{i,j \in 1..n~i \neq j} \\ 
    \Sigma \mid \Gamma@A_i \vdash \tau_i' :: \kappa_i^{~i \in 1..n} \\ \Sigma \vdash \kappa_i <:: \ast^{~i \in 1..n}}
  {\Sigma \mid \Gamma@(A \capdot \bigcapdot_{i \in 1..n} A_i \capdot B_i) \vdash \tau.\{[\tau_i] :^{m_i} \tau_i'^{~i \in 1..n}\} :: \mathit{KTree}(d)}
\and
\inferrule[Path]
  {\Sigma \vdash S_i^{~i \in 1..n}}
  {\Sigma \mid \Gamma@(\{ (S_1,\ldots,S_n).[\phi] \}) \vdash (S_1,\ldots,S_n).[\phi] :: \mathit{KString}(\mathit{Prefix}~\epsilon,\phi)}
\and
\inferrule[StrAbs]
  {\Sigma, \zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa}
  {\Sigma \mid \Gamma @ \emptyset \vdash \lambda \zeta. \tau :: \forall \zeta. \kappa}
\and
\inferrule[TyAbs]
  {\Sigma \mid \Gamma,\alpha :: \kappa @ A \vdash \tau :: \kappa'}
  {\Sigma \mid \Gamma @ \emptyset \vdash \lambda (\alpha :: \kappa).\tau :: \kappa \overset{A}{\Rightarrow} \kappa'}
\and
\inferrule[TyApp]
  {\Sigma \mid \Gamma @ A \vdash \tau :: \kappa \overset{C}{\Rightarrow} \iota \\ 
   \Sigma \mid \Gamma @ B \vdash \tau' :: \kappa' \\ \Sigma \vdash \kappa' <:: \kappa}
  {\Sigma \mid \Gamma @ (A \capdot B \capdot C) \vdash \tau~\tau' :: \iota}
\and
\inferrule[StrApp]
  {\Sigma \mid \Gamma @ A \vdash \tau :: \forall \zeta. \kappa \\ \Sigma \vdash S}
  {\Sigma \mid \Gamma @ A \vdash \tau~[S] :: \kappa[S/\zeta]}

\end{mathpar}
We write $\Sigma \vdash \Gamma$ to mean that $\Sigma \vdash \kappa$ for all $(x : \kappa) \in \Gamma$.
When $\Gamma = x_1 : \kappa_1, \ldots, x_n : \kappa_n$, we define the interpretation $\sem{\Sigma \vdash \Gamma} \defeq \sem{\Sigma \vdash \kappa_1} \times \cdots \times \sem{\Sigma \vdash \kappa_n}$, where products in $\mathit{Fam}(\mbf{Posets})$ are taken pointwise.
We will prove that $\Sigma \mid \Gamma @ A \vdash \tau :: \kappa$ implies each of $\Sigma \vdash \Gamma$, $\Sigma \vdash \kappa$, and $\Sigma \vdash A$. The interpretation $$\sem{\Sigma \mid \Gamma @ A \vdash \tau :: \kappa}$$ of a kinding judgment is a morphism of the fibre category $\mathit{Fam}(\mbf{Posets})_{\sem{\Sigma}}$ from $D_{\Sigma} A(\sem{\Sigma \vdash \Gamma})$ to $\sem{\Sigma \vdash \kappa}$.

\begin{mathpar}
\inferrule[TyVar]
  {i \in 1..n}
  {\sem{\Sigma \mid x_1:\kappa, \ldots, x_n :: \kappa_n \vdash x_i :: \kappa_i} \defeq \pi_{\sem{\Sigma \vdash \kappa_1},\ldots,\sem{\Sigma \vdash \kappa_n}}^i}
\and
\inferrule[Record]
  {\sem{\Sigma \mid \Gamma@A \vdash \tau :: \mathit{KString}(d,\phi)} = f \\ 
   \sem{\Sigma \mid \Gamma@B_i \vdash \tau_i :: \mathit{KString}(d_i,\phi_i)} = k_i^{~i \in 1..n} \\ 
    \sem{\Sigma \mid \Gamma@A_i \vdash \tau_i' :: \kappa_i} = h_i^{~i \in 1..n} \\ 
    \sem{\Sigma \vdash \kappa_i <:: \ast} = j_i^{~i \in 1..n} \\ 
    \sem{\Sigma \vdash \mbf{disj}~d_i~d_j} = X_{(i,j)}~^{i,j \in 1..n~i \neq j} }
  {\sem{\Sigma \mid \Gamma@(A \capdot \bigcapdot_{i \in 1..n} A_i \capdot B_i) \vdash \tau.\{[\tau_i] :^{m_i} \tau_i'^{~i \in 1..n}\} :: \mathit{KTree}(d)}_\sigma (\gamma,a) \defeq \\ \{ g \in \mathit{Inst} \mid (g(\epsilon) \in f_\sigma(\gamma,a)) \wedge (\forall s \in k_{i \sigma}(\gamma,a).~g \! \mid_{[s]} \in (h_{j \sigma};j_{i \sigma})(\gamma,a))^{i \in 1 ..n} \wedge \\ (g \# k_{i \sigma}(\gamma,a) \in \sem{m_i})^{i \in 1..n} \} }
\and
\inferrule[Path]
  {\sem{\Sigma \vdash S_i} = f_i^{~i \in 1..n}}
  {\sem{\Sigma \mid \Gamma@(\{ (S_1,\ldots,S_n).[\phi] \}) \vdash (S_1,\ldots,S_n).[\phi] :: \mathit{KString}(\mathit{Prefix}~\epsilon,\phi)}_{\sigma}(\gamma,a) \defeq \\ \{ s \in \mathit{Strings} \mid a \downarrow \downarrow [f_{1 \sigma}(\gamma),\ldots,f_{n \sigma}(\gamma),s] \}}
\and
\inferrule[StrAbs]
  {\sem{\Sigma, \zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa} = f : D_{\Sigma,\zeta}\emptyset(\sem{\Sigma,\zeta \vdash \Gamma}) \to \sem{\Sigma,\zeta \vdash \kappa}}
  {\sem{\Sigma \mid \Gamma @ \emptyset \vdash \lambda \zeta. \tau :: \forall \zeta. \kappa} \defeq f^\flat : D_{\Sigma} \emptyset(\sem{\Sigma \vdash \Gamma}) \to \sem{\Sigma \vdash \forall \zeta. \kappa)}}
\and
\inferrule[TyAbs]
  {\sem{\Sigma \mid \Gamma,\alpha :: \kappa @ A \vdash \tau :: \kappa'} = f : D_{\Sigma} A(\sem{\Sigma \vdash \Gamma,\alpha :: \kappa}) \to \sem{\Sigma \vdash \kappa'}}
  {\sem{\Sigma \mid \Gamma @ \emptyset \vdash \lambda (\alpha :: \kappa).\tau :: \kappa \overset{A}{\Rightarrow} \kappa'} \defeq \Lambda(m_{\Sigma,A,\Gamma,\kappa};f) : D_{\Sigma} \emptyset(\sem{\Sigma \vdash \Gamma}) \to \sem{\Sigma \vdash \kappa \overset{A}{\Rightarrow} \kappa'}}
\and
\inferrule[TyApp]
  {\sem{\Sigma \mid \Gamma @ A \vdash \tau :: \kappa \overset{C}{\Rightarrow} \iota} = f : D_\Sigma A \sem{\Sigma \vdash \Gamma} \to (D_\Sigma C \sem{\Sigma \vdash \kappa} \Rightarrow \sem{\Sigma \vdash \iota}) \\ 
   \sem{\Sigma \mid \Gamma @ B \vdash \tau' :: \kappa} = g : D_\Sigma B \sem{\Sigma \vdash \Gamma} \to \sem{\Sigma \vdash \kappa}}
  {\sem{\Sigma \mid \Gamma @ (A \capdot B \capdot C) \vdash \tau~\tau' :: \iota} = \\ 
\langle (\mathit{sub}_{A \capdot B \capdot C, A})_{\sem{\Sigma \vdash \Gamma}};f, (\mathit{sub}_{A \capdot B \capdot C,C \capdot B})_{\sem{\Sigma \vdash \Gamma}};(\delta_{C,B})_{\sem{\Sigma \vdash \Gamma}};D_{\Sigma} C(g) \rangle;(\mathit{ev})_{D_{\Sigma}C(\sem{\Sigma \vdash \Gamma})}}
\and
\inferrule[StrApp]
  {\sem{\Sigma \mid \Gamma @ A \vdash \tau :: \forall \zeta. \kappa} = f : D_{\Sigma}A(\sem{\Sigma \vdash \Gamma}) \to \sem{\Sigma \vdash \forall \zeta. \kappa} \\ \sem{\Sigma \vdash S} = g : \sem{\Sigma} \to \mathit{Strings}}
  {\sem{\Sigma \mid \Gamma @ A \vdash \tau~[S] :: \kappa[S/\zeta]} \defeq \langle id_{\sem{\Sigma}}, g \rangle^*(f^\sharp) : D_{\Sigma} A(\sem{\Sigma \vdash \Gamma}) \to \langle id_{\Sigma}, g \rangle^* \sem{\Sigma,\zeta \vdash \kappa}}

\end{mathpar}

\subsection*{Explanation}

\subsubsection*{\sc{StrAbs}}
For the string abstraction rule (second-to-last) is essentially mapping across an adjunction, but we need the following lemma to see this.
\begin{lemma}
$\pi^*_{\Sigma,\zeta}(D_{\Sigma} \emptyset(\sem{\Sigma \vdash \Gamma})) = D_{\Sigma,\zeta} \emptyset(\sem{\Sigma,\zeta \vdash \Gamma})$
\end{lemma}

\subsubsection*{\sc{StrApp}}

The domain of the conclusion should be $D_{\Sigma}A(\sem{\Sigma \vdash \Gamma})$. The domain of $\langle \mathit{id}_{\Sigma}, g \rangle^*(f^\sharp)$ is $\langle \mathit{id}_{\sem{\Sigma}}, g \rangle^* \pi_{\Sigma,\zeta}^*(D_{\Sigma} A \sem{\Sigma \vdash \Gamma})$, which is equal to $D_{\Sigma}A(\sem{\Sigma \vdash \Gamma})$ due to the following calculation.\\~\\
\begin{tabu}{l}
$\langle \mathit{id}_{\sem{\Sigma}}, g \rangle^* \pi_{\Sigma,\zeta}^* D_{\Sigma} A (\sem{\Sigma \vdash \Gamma})$ \\
$= (\langle \mathit{id}_{\sem{\Sigma}}, g \rangle; \pi_{\Sigma,\zeta})^* D_{\Sigma} A (\sem{\Sigma \vdash \Gamma})$ \\
$= id_{\sem{\Sigma}}^* D_{\Sigma} A (\sem{\Sigma \vdash \Gamma})$ \\
$= D_{\Sigma} A (\sem{\Sigma \vdash \Gamma})$
\end{tabu}

\subsection*{Index exchange lemmas}

\begin{definition}
We write $\pi_n$ as an abbreviation for $$\pi_{\sem{\zeta_n,\ldots,\zeta_{2}},\sem{\zeta_1}} : \sem{\zeta_n,\ldots,\zeta_{2}} \times \sem{\zeta_1} \to \sem{\zeta_n,\ldots,\zeta_{2}}$$ and $\pi'_n$ for $$\pi'_{\sem{\zeta_n,\ldots,\zeta_{2}},\sem{\zeta_1}} : \sem{\zeta_n,\ldots,\zeta_{2}} \times \sem{\zeta_1} \to \sem{\zeta_1}$$ We define a family of functions $$\mathit{swap}_{n,i} : \sem{\zeta_n,\ldots,\zeta_{i+1},\zeta_i,\ldots,\zeta_1} \to \sem{\zeta_n,\ldots,\zeta_i,\zeta_{i+1},\ldots,\zeta_1}$$ as $$\mathit{swap}_{n,1} \defeq \langle \langle \pi_n; \pi_{n-1}, \pi_n' \rangle, \pi_n;\pi_{n-1}' \rangle$$ and for $1 < i < n$, $$\mathit{swap}_{n,i} \defeq \langle \pi_n;\mathit{swap}_{(n-1),(i-1)}, \pi_n' \rangle$$
We write $|\Sigma|$ for the number of variables contained in index context $\Sigma$.
\end{definition}

\begin{lemma}
For $1 \leq i < n$, if $$\zeta_n,\ldots,\zeta_{i+1},\zeta_i,\ldots,\zeta_1 \vdash \kappa$$ then $$\zeta_n,\ldots,\zeta_{i},\zeta_{i+1},\ldots,\zeta_1 \vdash \kappa$$ and $$\sem{\zeta_n,\ldots,\zeta_{i},\zeta_{i+1},\ldots,\zeta_1 \vdash \kappa} = \mathit{swap}_{n,i}^* \sem{\zeta_n,\ldots,\zeta_{i+1},\zeta_i,\ldots,\zeta_1 \vdash \kappa}$$
\label{lemma:kwf-exchng}
\end{lemma}
 
\begin{proof}
By induction on the structure of $\zeta_n,\ldots,\zeta_{i+1},\zeta_i,\ldots,\zeta_1 \vdash \kappa$.
For brevity, we write $f$ for $swap_{n,i}$ and $\cdots \zeta_{i+1},\zeta_i \cdots$ for $\zeta_n,\ldots,\zeta_{i+1},\zeta_{i},\ldots,\zeta_1$ in what follows.
\begin{description}
\item[KWF-Str]:~\\
Apply the exchange lemma to the premise $\cdots \zeta_{i},\zeta_{i+1} \cdots \vdash d$ to get $$\cdots \zeta_{i+1},\zeta_{i} \cdots \vdash d$$ and $$\sem{\cdots\zeta_i,\zeta_{i+1}\cdots \vdash d} = f^* \sem{\cdots\zeta_{i+1},\zeta_i\cdots \vdash d}$$ Apply \begin{sc}KWF-Str\end{sc} to get $$\cdots\zeta_{i},\zeta_{i+1}\cdots \vdash \mathit{KString}(d,\phi)$$
Furthermore,we have\\~\\
$\sem{\cdots \zeta_{i},\zeta_{i+1} \cdots \vdash \mathit{KString}(d,\phi)}_\sigma$\\~\\
$= (~(\mathcal P (X), \subseteq)~),~~\small{X \defeq \{ \{ \epsilon \mapsto s\} \in \mathit{Inst} \mid s \in \sem{\cdots \zeta_{i},\zeta_{i+1} \cdots \vdash d}_\sigma \wedge \mathit{chars}(s) \subseteq \phi \}}$\\~\\
$= (~(\mathcal P (X), \subseteq)~),~~\small{X \defeq \{ \{ \epsilon \mapsto s\} \in \mathit{Inst} \mid s \in (f^*\sem{\cdots\zeta_{i+1},\zeta_i,\cdots \vdash d})_\sigma \wedge \mathit{chars}(s) \subseteq \phi \}}$\\~\\
$= (~(\mathcal P (X), \subseteq)~),~~\small{X \defeq \{ \{ \epsilon \mapsto s\} \in \mathit{Inst} \mid s \in \sem{\cdots \zeta_{i+1},\zeta_i \cdots \vdash d}_{f(\sigma)} \wedge \mathit{chars}(s) \subseteq \phi \}}$\\~\\
$= \sem{\cdots,\zeta_{i+1},\zeta_i \cdots \vdash \mathit{KString}(d,\phi)}_{f(\sigma)}$\\~\\
$= (f^* \sem{\cdots \zeta_{i+1},\zeta_i \cdots \vdash \mathit{KString}(d,\phi)})_\sigma $
\item[KWF-Tree]:~\\
Similar to the above case.

\item[KWF-TyFun]:~\\ 

Applying the IH gives $$\cdots \zeta_i,\zeta_{i+1} \cdots \vdash \kappa$$ $$\cdots \zeta_i,\zeta_{i+1} \cdots \vdash \kappa'$$ $$\sem{\cdots \zeta_i,\zeta_{i+1} \cdots \vdash \kappa} = f^*\sem{\cdots \zeta_{i+1},\zeta_i \cdots \vdash \kappa}$$ $$\sem{\cdots \zeta_i,\zeta_{i+1} \cdots \vdash \kappa} = f^*\sem{\cdots \zeta_{i+1},\zeta_i \cdots \vdash \kappa} $$
Applying the exchange lemma for coeffect well-formedness judgments gives $$\cdots \zeta_{i},\zeta_{i+1} \cdots \vdash A$$ $$\sem{\cdots \zeta_i,\zeta_{i+1} \cdots \vdash A} = f^*\sem{\cdots \zeta_{i+1},\zeta_i \cdots \vdash A} $$

Applying \begin{sc}KWF-TyFun\end{sc} gives $\cdots \zeta_i,\zeta_{i+1} \cdots \vdash \kappa \overset{A}{\Rightarrow} \kappa'$. Furthermore, we have\\~\\
$= (f^* \sem{\scdots \zeta_{i+1},\zeta_i \scdots \vdash \kappa \overset{A}{\Rightarrow} \kappa'})_\sigma$\\~\\
$= \sem{\scdots \zeta_{i+1},\zeta_i \scdots \vdash \kappa \overset{A}{\Rightarrow} \kappa'}_{f(\sigma)}$\\~\\
$= D_{(\cdots \zeta_{i+1},\zeta_i \cdots)} A(\sem{\cdots \zeta_{i+1},\zeta_i \cdots \vdash \kappa})_{f(\sigma)} \Rightarrow \sem{\cdots \zeta_{i+1},\zeta_i \cdots \vdash \kappa'}_{f(\sigma)}$\\~\\
$= \sem{\scdots \zeta_{i+1},\zeta_i \scdots \vdash \kappa}_{f(\sigma)} \times \sem{\scdots \zeta_{i+1},\zeta_i \scdots \vdash A}_{f(\sigma)} \Rightarrow \sem{\scdots \zeta_{i+1},\zeta_i \scdots \vdash \kappa'}_{f(\sigma)}$\\~\\
$= (f^* \sem{\scdots \zeta_{i+1},\zeta_i \scdots \vdash \kappa})_\sigma \times (f^*\sem{\scdots \zeta,\zeta' \scdots \vdash A})_{\sigma} \Rightarrow (f^* \sem{\scdots \zeta_{i+1},\zeta_i \scdots \vdash \kappa'})_\sigma$\\~\\
$= \sem{\scdots \zeta_{i},\zeta_{i+1} \scdots \vdash \kappa}_\sigma \times \sem{\scdots \zeta_i,\zeta_{i+1} \scdots \vdash A}_{\sigma} \Rightarrow \sem{\scdots \zeta_i,\zeta_{i+1} \scdots \vdash \kappa'}_\sigma$\\~\\
$= D_{(\scdots \zeta_i,\zeta_{i+1} \scdots)} A(\sem{\scdots \zeta_{i},\zeta_{i+1} \scdots \vdash \kappa})_\sigma \Rightarrow \sem{\scdots \zeta_{i},\zeta_{i+1} \scdots \vdash \kappa'}_\sigma$\\~\\
$\sem{\scdots \zeta_i,\zeta_{i+1} \scdots \vdash \kappa \overset{A}{\Rightarrow} \kappa'}_\sigma$\\

\item[KWF-StrFun]:~\\

Assume we have a proof of $\zeta_n,\ldots,\zeta_{i+1},\zeta_i,\ldots,\zeta_1 \vdash \forall \xi. \kappa$. Through $\alpha$-renaming, this is equivalent to proof of $\zeta_{n+1},\ldots,\zeta_{i+2},\zeta_{i+1},\ldots,\zeta_2 \vdash \forall \zeta_1. \kappa$. Its subproof concludes $\zeta_{n+1}, \ldots, \zeta_{i+2},\zeta_{i+1} \ldots, \zeta_1 \vdash \kappa$.  Applying the IH gives $$\zeta_{n+1},\ldots,\zeta_{i+1},\zeta_{i+2},\ldots,\zeta_1 \vdash \kappa$$ and, writing $f$ for $\mathit{swap}_{n+1,i+1}$, $$\sem{\zeta_{n+1},\ldots,\zeta_{i+1},\zeta_{i+2},\ldots,\zeta_1 \vdash \kappa} = f^* \sem{\zeta_{n+1},\ldots,\zeta_{i+2},\zeta_{i+1},\ldots,\zeta_1 \vdash \kappa}$$ Applying the \begin{sc}KWF-StrFun\end{sc} gives $$\zeta_{n+1},\ldots,\zeta_{i+1},\zeta_{i+2},\ldots,\zeta_2 \vdash \forall \zeta_1. \kappa $$

Furthermore, writing $\cdots \zeta_{i+1},\zeta_{i+2},\cdots$ for $\zeta_{n+1},\ldots,\zeta_{i+1},\zeta_{i+2},\ldots,\zeta_2$, for $\sigma \in \sem{\cdots \zeta_{i+1},\zeta_{i+2} \cdots}$ we have\\~\\
$\sem{\cdots \zeta_{i+1},\zeta_{i+2} \cdots \vdash \forall \zeta_1. \kappa}_\sigma$\\~\\
$= (\Pi_{\sem{\cdots \zeta_{i+1},\zeta_{i+2} \cdots}, \sem{\zeta_1}} \sem{\cdots \zeta_{i+1},\zeta_{i+2} \cdots,\zeta_1 \vdash \kappa})_\sigma$\\~\\
$= \Pi_{t \in \sem{\zeta_1}} \sem{\cdots \zeta_{i+1},\zeta_{i+2} \cdots,\zeta_1 \vdash \kappa}_{\sigma,t}$\\~\\
$= \Pi_{t \in \sem{\zeta_1}} (f^* \sem{\cdots \zeta_{i+2},\zeta_{i+1} \cdots \zeta_1 \vdash \kappa})_{\sigma,t}$\\~\\
$= (\Pi_{\sem{\cdots,\zeta_{i+1},\zeta_{i+2} \cdots},\sem{\zeta_1}} f^* \sem{\cdots \zeta_{i+2},\zeta_{i+1} \cdots,\zeta_1 \vdash \kappa} )_\sigma$\\~\\
$= (\Pi_{\sem{\cdots,\zeta_{i+1},\zeta_{i+2} \cdots},\sem{\zeta_1}} (\mathit{swap}_{n,i} \times \mathit{id})^* \sem{\cdots \zeta_{i+2},\zeta_{i+1} \cdots,\zeta_1 \vdash \kappa} )_\sigma$\\~\\
$= (\mathit{swap}_{n,i}^* \Pi_{\sem{\cdots \zeta_{i+2},\zeta_{i+1} \cdots},\sem{\zeta_1}} \sem{\cdots \zeta_{i+2},\zeta_{i+1} \cdots,\zeta_1 \vdash \kappa})_\sigma$\\~\\
$= (\mathit{swap}_{n,i}^* \sem{\cdots \zeta_{i+2},\zeta_{i+1} \cdots \vdash \forall \zeta_1 . \kappa})_\sigma$

\end{description}

\end{proof}

\begin{lemma}
If $\zeta_n,\ldots,\zeta_{i+1},\zeta_i,\ldots,\zeta_1 \mid \Gamma@A \vdash \tau :: \kappa$ then $\zeta_n,\ldots,\zeta_{i},\zeta_{i+1},\ldots,\zeta_1 \mid \Gamma@A \vdash \tau :: \kappa$ and $$\sem{\zeta_n,\ldots,\zeta_{i},\zeta_{i+1},\ldots,\zeta_1 \mid \Gamma@A \vdash \tau :: \kappa} = \mathit{swap}_{n,i}^* \sem{\zeta_n,\ldots,\zeta_{i+1},\zeta_i,\ldots,\zeta_1 \mid \Gamma@A \vdash \tau :: \kappa}$$
\label{K-exchng}
\end{lemma}

\begin{proof}
Again, we write $\cdots \zeta_{i+1},\zeta_i$ for...
TODO
\end{proof}

\subsection*{Index substitution lemmas}

\subsubsection*{Notation}

Given sets $I$ and $I$ and a function $u : I \to J$, we write $u^* : \mathit{Fam}(\mbf{Posets})_J \to \mathit{Fam}(\mbf{Posets})_I$ for the substitution functor induced by $u$, e.g. for an $J$-indexed family of posets $\sdisp{P_j}_{j \in J}$ we have $u^* \sdisp{P_j}_{j \in J} = \sdisp{ P_{u(i)} }_{i \in I}$.

We overload the notation $u^*$ to other forms of set-indexed families. For example, we can also use $u^* : \mathit{Fam}(\mathit{Strings})_J \to \mathit{Fam}(\mathit{Strings})_I$ to reindex $J$-indexed families of strings, considering the set $\mathit{Strings}$ as a discrete category. 

\begin{lemma}
If $\Sigma,\zeta \vdash S$ and $\Sigma \vdash S'$ then $\Sigma \vdash S[S'/\zeta]$. Furthermore, $$\sem{\Sigma \vdash S[S'/\zeta]} = \langle \mathit{id}, \sem{\Sigma \vdash S'} \rangle^* \sem{\Sigma,\zeta \vdash S}$$
\label{SWF-Subst}
\end{lemma}
\begin{proof}
By cases on $S$.

\begin{description}
\item[Case $S = s$]:\\
We have $S[S'/\zeta] = s[S'/\zeta] = s$. By \begin{sc}IWF-Lit\end{sc}, $s$ is a well-formed index term in any index environment, so in particular we have $\Sigma \vdash s$ i.e. $\Sigma \vdash s[S'/\zeta]$.

Semantically, we have $\sem{\Sigma \vdash s} = \langle \mathit{id}, \sem{\Sigma \vdash S'} \rangle^* \sem{\Sigma,\zeta \vdash s}$, since the left-hand side is defined as $$( s )_{\sigma \in \sem{\Sigma}}$$ and the right-hand side is $$\langle \mathit{id}, \sem{\Sigma \vdash S'} \rangle^* ( s )_{\sigma \in \sem{\Sigma,\zeta}}$$ which simplifies to $$ ( s )_{\sigma \in \sem{\Sigma}}$$

\item[Case ]$S = \zeta'$:\\
We have $\Sigma,\zeta \vdash \zeta'$. So either $\zeta' \in \Sigma$ or $\zeta' = \zeta$.

\begin{description}
\item[Case $\zeta' \in \Sigma$]:\\
We have $S[S'/\zeta] = \zeta'$, and since $\zeta' \in \Sigma$, \begin{sc}IWF-Var\end{sc} gives $\Sigma \vdash \zeta'$, i.e. $\Sigma \vdash S[S'/\zeta]$.

Semantically, we have $\sem{\Sigma \vdash \zeta'} = \langle \mathit{id}, \sem{\Sigma \vdash S'} \rangle^* \sem{\Sigma,\zeta \vdash S}$, because the left-hand side is defined as $$\sdisp{\sigma(\zeta')}_{\sigma \in \sem{\Sigma}}$$ while the right-hand side is equal to $$\langle \mathit{id}, \sem{\Sigma \vdash \zeta'} \rangle^* (\sigma(\zeta'))_{\sigma \in \sem{\Sigma,\zeta}}$$ which simplifies to $$(\sigma(\zeta'))_{\sigma \in \sem{\Sigma}}$$
 
\item[Case $\zeta' = \zeta$]:\\
We have $S[S'/\zeta] = S'$. By assumption, $\Sigma \vdash S'$, i.e. $\Sigma \vdash S[S'/\zeta]$.

Semantically, we have $\sem{\Sigma \vdash S'} = \langle \mathit{id}, \sem{\Sigma \vdash S'} \rangle^* \sem{\Sigma,\zeta \vdash \zeta}$ since the right-hand is equal to $$\langle \mathit{id}, \sem{\Sigma \vdash S'} \rangle^* (\sigma(\zeta))_{\sigma \in \sem{\Sigma,\zeta}}$$
which is equal to
$$( \sem{\Sigma,\zeta \vdash \zeta}_{\langle \mathit{id}, \sem{\Sigma \vdash S'} \rangle(\sigma)} )_{\sigma \in \sem{\Sigma}}$$
which is equal to
$$ $$
\end{description}

\end{description}

\end{proof}

\begin{lemma}
If $\Sigma,\zeta \vdash d$ and $\Sigma \vdash S$ then $\Sigma \vdash d[S/\zeta]$
\label{DWF-Subst}
\end{lemma}

\begin{proof}
By cases on $d$

\item[Case $d = \mathit{Prefix}~S'$]:\\
Since $\Sigma,\zeta \vdash \mathit{Prefix}~S'$ we get $\Sigma,\zeta \vdash S'$ from the premise of 
\begin{sc}DWF-Prefix\end{sc}. By Lemma \ref{SWF-Subst} we get $\Sigma \vdash S'[S/\zeta]$. Applying
\begin{sc}DWF-Prefix\end{sc} using the premise $\Sigma \vdash S'[S/\zeta]$ then gives $\Sigma \vdash \mathit{Prefix}~S'[S/\zeta]$, i.e. $\Sigma \vdash d[S/\zeta]$.

\item[Case $d = \mathit{Literal}~S'$]:\\
Similar to the previous case.

\end{proof}

\begin{lemma}
If $\Sigma,\zeta \vdash A$ and $\Sigma \vdash S$ then $\Sigma \vdash A[S/\zeta]$ and
$$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma, \zeta \vdash A} = \sem{\Sigma \vdash A[S/\zeta]}$$
\end{lemma}

\begin{proof}
If $\Sigma,\zeta \vdash A$ then for each $(S_1,\ldots,S_n).[\phi] \in A$ we have $\Sigma,\zeta \vdash S_i^{~i \in 1..n}$. By Lemma \ref{SWF-Subst} we have $\Sigma \vdash S_i[S/\zeta]$ and $$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash S_i} = \sem{\Sigma \vdash S_i[S/\zeta]}$$ From this, we deduce that $\Sigma \vdash (S_1[S/\zeta],\ldots,S_n[S/\zeta]).[\phi]$; hence $\Sigma \vdash A[S/\zeta]$. \\~\\
And for $\sigma \in \sem{\Sigma}$, writing $\rho$ for $\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)$, we have\\~\\ 
$(\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash A})_\sigma$\\~\\
$= \sem{\Sigma,\zeta \vdash A}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}$\\~\\
$= \sdisp{\bigcap_{(S_1,\ldots,S_n).[\phi] \in A} \{ f \in \mathit{Inst} \mid \forall s \in \mathit{keys}(f \! \mid_{\sem{\Sigma,\zeta \vdash S_1}_\rho, \ldots, \sem{\Sigma,\zeta \vdash S_n}_\rho}).~\mathit{chars}(s) \subseteq \phi \},~\leq}$\\~\\
$= \sdisp{\bigcap_{(S_1,\ldots,S_n).[\phi] \in A} \{ f \in \mathit{Inst} \mid \forall s \in \mathit{keys}(f \! \mid_{   (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash S_1})_\sigma, \ldots, (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash S_n})_\sigma}).~\mathit{chars}(s) \subseteq \phi \},~\leq}$\\~\\
$= \sdisp{\bigcap_{(S_1,\ldots,S_n).[\phi] \in A} \{ f \in \mathit{Inst} \mid \forall s \in \mathit{keys}(f \! \mid_{   \sem{\Sigma \vdash S_1[S/\zeta]}_\sigma, \ldots, \sem{\Sigma \vdash S_n[S/\zeta]}_\sigma}).~\mathit{chars}(s) \subseteq \phi \},~\leq}$\\~\\
$= \sdisp{\bigcap_{(S_1,\ldots,S_n).[\phi] \in A[S/\zeta]} \{ f \in \mathit{Inst} \mid \forall s \in \mathit{keys}(f \! \mid_{\sem{\Sigma \vdash S_1}_\sigma, \ldots, \sem{\Sigma \vdash S_n}_\sigma}).~\mathit{chars}(s) \subseteq \phi \},~\leq}$\\~\\
$= \sem{\Sigma \vdash A[S/\zeta]}_\sigma$
\end{proof}~\\


\begin{lemma}
For all $\Sigma$, $\xi$, and $S$ with $\Sigma \vdash S$,  we have $$\langle \mathit{id}, \sem{\Sigma,\xi \vdash S} \rangle = \langle \langle \pi, \sem{\Sigma,\zeta \vdash S} \rangle, \pi' \rangle; \mathit{swap}_{n,1}$$
\label{lemma:subswap}
\end{lemma}

\begin{proof}~\\~\\
$\langle \mathit{id}, \sem{\Sigma,\zeta \vdash S} \rangle$\\~\\
$= \langle \langle \pi, \pi' \rangle; \sem{\Sigma, \zeta \vdash S} \rangle $\\~\\
$= \langle \langle \pi, \sem{\Sigma,\zeta \vdash S} \rangle, \pi' \rangle; \langle \langle \pi;\pi,\pi' \rangle, \pi;\pi' \rangle$\\~\\
$= \langle \langle \pi, \sem{\Sigma,\zeta \vdash S} \rangle, \pi' \rangle; swap_{n,1}$
\end{proof}

\begin{lemma}
If $\Sigma,\zeta \vdash \kappa$ and $\Sigma \vdash S$ then $\Sigma \vdash \kappa[S/\zeta]$ and $$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \kappa} \cong \sem{\Sigma \vdash \kappa[S/\zeta]}$$ 
\end{lemma}

\begin{proof}
By induction on the proof of $\Sigma,\zeta \vdash \kappa$. 

\begin{description}
\item[Case \sc{KWF-Str}]:~\\
We apply Lemma \ref{DWF-Subst} to the premise to get $\Sigma \vdash d[S/\zeta]$. Then applying 
\begin{sc}KWF-Str\end{sc} using $\Sigma \vdash d[S/\zeta]$ as the premise gives 
$\Sigma \vdash \mathit{KString}(d[S/\zeta],\phi)$, i.e. $\Sigma \vdash \kappa[S/\zeta]$.\\~\\
Furthermore, for $\sigma \in \sem{\Sigma}$, we have that\\~\\
$(\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \mathit{KString(d,\phi)}})_\sigma$\\~\\
$= \sem{\Sigma,\zeta \vdash \mathit{KString(d,\phi)}}_{\langle \mathit{id}, \sem{\Sigma \vdash S}(\sigma)}$\\~\\
$= (\{~\{ \epsilon \mapsto s \} \in \mathit{Inst} \mid s \in \sem{\Sigma,\zeta \vdash d}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle (\sigma)} \wedge \mathit{chars}(s) \subseteq \phi ~\} , \subseteq)$\\~\\
$= (\{~\{ \epsilon \mapsto s \} \in \mathit{Inst} \mid s \in \sem{\Sigma \vdash [S/\zeta]d}_{\sigma} \wedge \mathit{chars}(s) \subseteq \phi ~\} , \subseteq)$\\~\\
$= \sem{\Sigma \vdash \mathit{KString(d[S/\zeta],\phi)}}_\sigma$\\~\\
$= \sem{\Sigma \vdash (\mathit{KString(d,\phi)})[S/\zeta]}_\sigma$

\item[Case \sc{KWF-Tree}]:~\\
Similar to the above case.

\item[Case \sc{KWF-TyFun}]:~\\
Our inductive hypothesis gives $\Sigma \vdash \kappa[S/\zeta]$, $\Sigma \vdash \kappa'[S/\zeta]$,
$\Sigma \vdash A[S/\zeta]$, and furthermore $$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^*\sem{\Sigma,\zeta \vdash \kappa} = \sem{\Sigma \vdash \kappa[S/\zeta]},$$ $$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \kappa'} = \sem{\Sigma \vdash \kappa'[S/\zeta]}, \text{ and}$$ $$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash A} = \sem{\Sigma \vdash A[S/\zeta]}$$  Applying \begin{sc}KWF-TyFun\end{sc} gives $\Sigma \vdash \kappa[S/\zeta] \overset{A[S/\zeta]}{\Rightarrow} \kappa'[S/\zeta]$ i.e. $$\Sigma \vdash (\kappa \overset{A}{\Rightarrow} \kappa')[S/\zeta]$$

Furthermore, for $\sigma \in \sem{\Sigma}$ we have\\~\\ 
$(\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \kappa \overset{A}{\Rightarrow} \kappa'})_\sigma$\\~\\
$= \sem{\Sigma,\zeta \vdash \kappa \overset{A}{\Rightarrow} \kappa'}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}$\\~\\
$= D_{\Sigma} A( \sem{\Sigma,\zeta \vdash \kappa} )_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)} \Rightarrow \sem{\Sigma,\zeta \vdash \kappa'}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}$\\~\\
$= \sem{\Sigma,\zeta \vdash \kappa}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)} \times \sem{\Sigma \vdash A}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)} \Rightarrow \sem{\Sigma,\zeta \vdash \kappa'}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}$\\~\\
$= (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \kappa} )_\sigma \times (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma \vdash A})_\sigma \\ ~~~\Rightarrow (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma \vdash \kappa'})_\sigma$\\~\\
$= \sem{\Sigma \vdash \kappa[S/\zeta]}_\sigma \times \sem{\Sigma \vdash A[S/\zeta]}_\sigma \Rightarrow \sem{\Sigma \vdash \kappa'[S/\zeta]}_\sigma$\\~\\
$= D_{\Sigma} A[S/\zeta] (\sem{\Sigma \vdash \kappa[S/\zeta]})_\sigma \Rightarrow \sem{\Sigma \vdash \kappa'[S/\zeta]}_\sigma$\\~\\
$= \sem{\Sigma \vdash \kappa[S/\zeta] \overset{A[S/\zeta]}{\Rightarrow} \kappa'[S/\zeta]}_\sigma $\\~\\
$= \sem{\Sigma \vdash (\kappa \overset{A}{\Rightarrow} \kappa')[S/\zeta] }_\sigma$

\item[Case \sc{KWF-StrFun}]:~\\
The premise for proving $\Sigma,\zeta \vdash \forall \zeta'.\kappa$ is $\Sigma,\zeta,\zeta' \vdash \kappa$. Exchanging $\zeta$ and $\zeta'$ gives $\Sigma,\zeta',\zeta \vdash \kappa$. (The proof should be of the same height.) Applying the IH gives $\Sigma,\zeta' \vdash \kappa[S/\zeta]$ and $$\langle \mathit{id}, \sem{\Sigma,\zeta' \vdash S} \rangle^* \sem{\Sigma,\zeta',\zeta \vdash \kappa} \cong \sem{\Sigma,\zeta' \vdash \kappa[S/\zeta]}$$ Applying \begin{sc}KWF-StrFun\end{sc} gives $\Sigma \vdash \forall \zeta'. \kappa[S/\zeta]$ i.e.
$$\Sigma \vdash (\forall \zeta'. \kappa)[S/\zeta]$$
Furthermore, we have\\~\\
$(\langle \mathit{id}_{\sem{\Sigma}}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \forall \zeta'. \kappa})_\sigma$\\~\\
$= (\langle \mathit{id}_{\sem{\Sigma}}, \sem{\Sigma \vdash S} \rangle^* \Pi_{\sem{\Sigma,\zeta},\sem{\zeta'}} \sem{\Sigma,\zeta,\zeta' \vdash \kappa})_\sigma$\\~\\
$\cong (\Pi_{\sem{\Sigma},\sem{\zeta'}} (\langle \mathit{id}_{\sem{\Sigma}}, \sem{\Sigma \vdash S} \rangle \times \mathit{id}_{\sem{\zeta'}})^* \sem{\Sigma, \zeta, \zeta' \vdash \kappa})_\sigma$\\~\\
%$~~~~~~~~~\cong (\text{By lemmas } \ref{lemma:subswap} \text{ and } \ref{lemma:prescong})$\\~\\  
$= \Pi_{t \in \mathit{Strings}} \sem{\Sigma,\zeta,\zeta' \vdash \kappa}_{(\langle \mathit{id}, \sem{\Sigma,\zeta' \vdash S} \rangle; \mathit{swap}_{n,1})(\sigma, t)}$\\~\\ 
$= \Pi_{t \in \mathit{Strings}} (\mathit{swap}_{n,1}^* \sem{\Sigma,\zeta,\zeta' \vdash \kappa})_{(\langle \mathit{id}, \sem{\Sigma,\zeta' \vdash S} \rangle)(\sigma, t)}$\\~\\
$\cong \Pi_{t \in \mathit{Strings}} \sem{\Sigma,\zeta',\zeta \vdash \kappa}_{\langle \mathit{id}, \sem{\Sigma,\zeta' \vdash S} \rangle(\sigma, t)}$\\~\\
$= \Pi_{t \in \mathit{Strings}} (\langle \mathit{id}, \sem{\Sigma,\zeta' \vdash S} \rangle^* \sem{\Sigma,\zeta',\zeta \vdash \kappa})_{\sigma,t}$\\~\\
$= \Pi_{t \in \mathit{Strings}} (\sem{\Sigma,\zeta' \vdash \kappa[S/\zeta]})_{\sigma,t}$\\~\\
$= (\Pi_{\sem{\Sigma},\sem{\zeta'}} \sem{\Sigma,\zeta' \vdash \kappa[S/\zeta]})_\sigma$\\~\\
$= \sem{\Sigma \vdash \forall \zeta'. \kappa[S/\zeta]}$\\~\\
$= \sem{\Sigma \vdash (\forall \zeta'. \kappa)[S/\zeta]}$
\end{description}
\end{proof}

\begin{lemma}
If $\Sigma,\zeta \vdash d \leq d'$ and $\Sigma \vdash T$ then $\Sigma \vdash d[T/\zeta] \leq d'[T/\zeta]$ and 
$$\langle \mathit{id}, \sem{\Sigma \vdash T} \rangle^* \sem{\Sigma \vdash d \leq d'} = \sem{\Sigma,\zeta \vdash d \leq d'}$$.
\label{SD-Subst}
\end{lemma}

\begin{proof}
By cases on $\Sigma,\zeta \vdash d \leq d'$.
\begin{description}
\item[Case SD-PrefPref:]~\\
Since $s$ and $s'$ are string literals, we can apply \begin{sc}SD-PrefPref\end{sc} to obtain $\Sigma \vdash \mathit{Prefix}~s \leq \mathit{Prefix}~s'$. Since $(\mathit{Prefix}~s)[T/\zeta] = \mathit{Prefix}~s$ and likewise for $s'$, we have $\Sigma \vdash (\mathit{Prefix}~s)[T/\zeta] \leq (\mathit{Prefix}~s')[T/\zeta]$. Furthermore, for $\sigma \in \sem{\Sigma}$ we have\\~\\ 
$(\langle \mathit{id}, \sem{\Sigma \vdash T} \rangle^* \sem{\Sigma,\zeta \vdash \mathit{Prefix}~s \leq \mathit{Prefix}~s'})_\sigma$\\~\\
$= \sem{\Sigma,\zeta \vdash \mathit{Prefix}~s \leq \mathit{Prefix}~s'}_{\langle \mathit{id}, \sem{\Sigma \vdash T} \rangle(\sigma)}$\\~\\
$= i_{\{ t \mid s \sqsubseteq t \}, \{ t \mid s' \sqsubseteq t \}}$\\~\\
$= \sem{\Sigma \vdash \mathit{Prefix}~s \leq \mathit{Prefix}~s'}_{\sigma}$\\~\\
$= \sem{\Sigma \vdash (\mathit{Prefix}~s)[T/\zeta] \leq (\mathit{Prefix}~s')[T/\zeta]}_{\sigma}$
\item[Case SD-LitLit:]~\\
~
Applying Lemma ? to our hypothesis $\Sigma,\zeta \vdash S$ and our assumption $\Sigma \vdash T$ gives
$\Sigma \vdash S[T/\zeta]$ and $\langle \mathit{id}, \sem{\Sigma \vdash T} \rangle^* \sem{\Sigma,\zeta \vdash S} = \sem{\Sigma \vdash S[T/\zeta]}$. Applying \begin{sc}SD-LitLit\end{sc} then gives $$\Sigma \vdash \mathit{Literal}~S[T/\zeta] \leq \mathit{Literal}~S[T/\zeta]$$

Furthermore, for $\sigma \in \sem{\Sigma}$ we have\\~\\
$(\langle \mathit{id},\sem{\Sigma \vdash T} \rangle^* \sem{\Sigma,\zeta \vdash \mathit{Literal}~S \leq \mathit{Literal~S}})_\sigma$\\~\\
$= \sem{\Sigma,\zeta \vdash \mathit{Literal}~S \leq \mathit{Literal}~S}_{\langle \mathit{id}, \sem{\Sigma \vdash T}\rangle(\sigma)}$\\~\\
$= i_{\{ \sem{\Sigma,\zeta \vdash S}_{\langle \mathit{id}, \sem{\Sigma \vdash T}\rangle(\sigma)} \}, \{ \sem{\Sigma,\zeta \vdash S}_{\langle \mathit{id}, \sem{\Sigma \vdash T}\rangle(\sigma)} \}}$\\~\\
$= i_{\{~(\langle \mathit{id}, \sem{\Sigma \vdash T}\rangle^*\sem{\Sigma,\zeta \vdash S})_\sigma~\}, \{~(\langle \mathit{id}, \sem{\Sigma \vdash T}\rangle^*\sem{\Sigma,\zeta \vdash S})_\sigma~\}}$\\~\\
$= i_{ \{ \sem{\Sigma \vdash S[T/\zeta]}_{\sigma} \}, \{ \sem{\Sigma \vdash S[T/\zeta]}_{\sigma} \} }$\\~\\
$= \sem{\Sigma \vdash \mathit{Literal}~S[T/\zeta] \leq \mathit{Literal}~S[T/\zeta]}_{\sigma}$

\item[Case SD-LitPref:]~\\

Applying \begin{sc}SD-LitPref\end{sc} gives $\Sigma \vdash \mathit{Literal}~s \leq \mathit{Prefix}~s'$. Since $\mathit{Literal}~s[T/\zeta] = \mathit{Literal}~s$ and $\mathit{Prefix~s'}[T/\zeta] = \mathit{Prefix}~s'[T/\zeta]$ we have $\Sigma \vdash \mathit{Literal}~s \leq \mathit{Prefix}~s'$. Furthermore, for $\sigma \in \sem{\Sigma}$ we have\\~\\
$(\langle \mathit{id}, \sem{\Sigma \vdash T} \rangle^* \sem{\Sigma,\zeta \vdash \mathit{Literal}~s \leq \mathit{Prefix}~s'})_\sigma$\\~\\
$= \sem{\Sigma,\zeta \vdash \mathit{Literal}~s \leq \mathit{Prefix}~s'}_{\langle \mathit{id}, \sem{\Sigma \vdash T} \rangle(\sigma)}$\\~\\
$= i_{\{ s \}, \{ t \mid s' \sqsubseteq t \}}$\\~\\
$= \sem{\Sigma \vdash \mathit{Literal}~s \leq \mathit{Prefix}~s'}_{\sigma}$\\~\\
$= \sem{\Sigma \vdash (\mathit{Literal}~s)[T/\zeta] \leq (\mathit{Prefix}~s')[T/\zeta]}_{\sigma}$

\end{description}

\end{proof}

\begin{lemma}
If $\Sigma,\zeta \vdash \kappa <:: \kappa'$ and $\Sigma \vdash S$ then $\Sigma \vdash \kappa[S/\zeta] <:: \kappa'[S/\zeta]$ and $\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^*\sem{\Sigma,\zeta \vdash \kappa <:: \kappa'} = \sem{\Sigma \vdash \kappa[S/\zeta] <:: \kappa'[S/\zeta]}$.
\label{SK-Subst}
\end{lemma}

\begin{proof}
By induction on $\Sigma,\zeta \vdash \kappa <:: \kappa'$.

\begin{description}
\item[Case \begin{sc}SK-StrTree\end{sc}]:~\\
Applying lemma \ref{SD-Subst} to the premise $\Sigma,\zeta \vdash d \leq d'$ gives $$\Sigma \vdash d[S/\zeta] \leq d'[S/\zeta]$$ Applying \begin{sc}SK-StrTree\end{sc} gives $$\Sigma \vdash \mathit{KString(d[S/\zeta],\phi) <:: \mathit{KTree}(d'[S/\zeta])}$$
Furthermore, for $\sigma \in \sem{\Sigma}$ we have\\~\\
$(\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \mathit{KString}(d,\phi) <:: KTree(d')})_\sigma $\\~\\
$= \sem{\Sigma,\zeta \vdash \mathit{KString}(d,\phi) <:: KTree(d')}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}$\\~\\
$= a$

\item[Case \begin{sc}SK-StrStr\end{sc}]:~\\
Applying lemma \ref{SD-Subst} to the premise $\Sigma,\zeta \vdash d \leq d'$ gives $$\Sigma \vdash d[S/\zeta] \leq d'[S/\zeta]$$ Applying \begin{sc}SK-StrStr\end{sc} gives $$\Sigma \vdash \mathit{KString}(d[S/\zeta],\phi) <:: \mathit{KString}(d'[S/\zeta], \phi')$$
\item[Case \begin{sc}SK-TreeTree\end{sc}]:~\\
Applying lemma \ref{SD-Subst} to the premise $\Sigma,\zeta \vdash d \leq d'$ gives $$\Sigma \vdash d[S/\zeta] \leq d'[S/\zeta]$$ Applying \begin{sc}SK-TreeTree\end{sc} gives $$\Sigma \vdash \mathit{KTree}(d[S/\zeta]) <:: \mathit{KTree}(d'[S/\zeta])$$
\end{description}
\end{proof}

\begin{lemma}
If $\Sigma,\zeta \vdash \kappa <:: \star$ and $\Sigma \vdash S$ then
$\Sigma \vdash \kappa[S/\zeta] <:: \star$.
\label{SK-Subst2}
\end{lemma}

\begin{proof}
This lemma is a simple corollary of lemma \ref{SK-Subst}.
\end{proof}


\begin{lemma}
If $\Sigma,\zeta \vdash \kappa <:: \ast$ and $\Sigma \vdash S$ then
$\Sigma \vdash \kappa[S/\zeta] <:: \ast^{~i \in 1..n}$.
\label{SK-Subst3}
\end{lemma}

\begin{proof}
Another simple corollary of lemma \ref{SK-Subst}.
\end{proof}

\subsection*{Kinding index substitution Lemma}

\begin{lemma}
If $$\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \kappa$$ and $$\Sigma \vdash S$$ then $$\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta ] :: \kappa [S/\zeta ]$$ and furthermore $$\sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \kappa[S/\zeta]} = \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \kappa}$$
\end{lemma}

\begin{proof}
By induction on the proof $\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \kappa$.

\begin{description}
\item[Case \sc{Record}]:~\\
The inductive hypothesis gives~\\~\\ 1.) $$\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \mathit{KString}([S/\zeta]d,\phi)$$ 2.)
\begin{center}
$\sem{\Sigma \mid \Gamma[S/\zeta]@A[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: KString([S/\zeta]d,\phi)}$\\$=$\\ 
$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \mathit{KString}(d,\phi)}$
\end{center}
3.)\\
$$\Sigma \mid \Gamma[S/\zeta] @ B_i[S/\zeta] \vdash \tau_i[S/\zeta] :: \mathit{KString}(d_i[S/\zeta],\phi_i)^{~i \in 1..n}$$
4.)
\begin{center}
$\sem{\Sigma \mid \Gamma[S/\zeta] @ B_i[S/\zeta] \vdash \tau_i[S/\zeta] :: \mathit{KString}(d_i[S/\zeta],\phi_ii)}$\\
$=$\\ 
$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ B_i \vdash \tau_i :: \mathit{KString}(d_i,\phi_i)}$
\end{center}
5.)
$$\Sigma \mid \Gamma[S/\zeta ]@ A_i[S/\zeta] \vdash \tau_i'[S/\zeta] :: \kappa_i[S/\zeta]^{~i \in 1..n}$$
After applying the IH, we apply Lemma \ref{SK-Subst3} to get
$$\Sigma \vdash \kappa_i[S/\zeta] <:: \ast^{~i \in 1..n}$$ 
and
$$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \kappa_i <:: \ast} = \sem{\Sigma \vdash \kappa_i[S/\zeta] <:: \ast}^{~i \in 1..n}$$
and we apply Lemma \ref{DISJ-Subst} to get $$\Sigma \vdash \mbf{disj}~d_i[S/\zeta]~d_j[S/\zeta]^{~i,j \in 1..n~i \neq j}$$
and
$$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \mbf{disj}~d_i~d_j} = \sem{\Sigma \vdash \mbf{disj}~d_i[S/\zeta]~d_j[S/\zeta]}^{~i,j \in 1..n~i \neq j}$$ 
Applying \begin{sc}Record\end{sc} then gives 
$$\Sigma \mid \Gamma[S/\zeta] @ (A[S/\zeta] \capdot \bigcapdot_{i \in 1.. n} A_i[S/\zeta] \capdot B_i[S/\zeta]) \vdash \tau[S/\zeta].\{ [\tau_i[S/\zeta] :^{m_i} \tau_i'[S/\zeta]^{~i \in 1..n} \} :: \mathit{KTree}(d[S/\zeta])$$
that is,
$$\Sigma \mid \Gamma[S/\zeta] @ (A \capdot \bigcapdot_{i \in 1..n} A_i \capdot B_i)[S/\zeta] \vdash (\tau.\{ [\tau_i] :^{m_i} \tau'_i \})[S/\zeta] :: (\mathit{KTree}(d))[S/\zeta]$$
and furthermore,
\begin{center}
\begin{tabular}{l}
$(\langle \mathit{id}, \sem{\Gamma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ (A \capdot \bigcapdot_{i \in 1..n} A_i \capdot B_i) \vdash \tau.\{ [\tau_i] :^{m_i} \tau_i' \} :: \mathit{KTree(d)} })_\sigma (\gamma,a)$ \\~\\
$= \sem{\Sigma,\zeta \mid \Gamma @ (A \capdot \bigcapdot_{i \in 1..n} A_i \capdot B_i) \vdash \tau.\{ [\tau_i] :^{m_i} \tau_i' \} :: \mathit{KTree(d)} }_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}(\gamma,a)$ \\~\\

$= \{ g \in \mathit{Inst} \mid$ \\
$~~~~~~g(\epsilon) \in \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \mathit{KString(d,\phi)}}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}(\gamma,a)~\wedge$ \\
$~~~~~~\forall s \in \sem{\Sigma,\zeta \mid \Gamma @ B_i \vdash \tau_i :: \mathit{KString}(d_i,\phi_i)}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}(\gamma,a).$\\
$~~~~~~~~g \! \mid_{[s]} \in (\sem{\Sigma,\zeta \mid \Gamma @ A_i \vdash \tau_i' :: \kappa_i};\sem{\Sigma,\zeta \vdash \kappa_i <:: \ast})_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}(\gamma,a)^{~i \in 1..n}~\wedge$\\
$~~~~~~g \# \sem{\Sigma,\zeta \mid \Gamma @ B_i \vdash \tau_i :: \mathit{KString}(d_i,\phi_i)}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}(\gamma,a) \in \sem{m_i}^{~i \in 1..n} \}$\\~\\

$= \{ g \in \mathit{Inst} \mid$ \\
$~~~~~~g(\epsilon) \in \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \mathit{KString(d,\phi)}}_{\sigma}(\gamma,a)~\wedge$ \\
$~~~~~~\forall s \in (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ B_i \vdash \tau_i :: \mathit{KString}(d_i,\phi_i)})_\sigma(\gamma,a).$\\
$~~~~~~~~g \! \mid_{[s]} \in (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A_i \vdash \tau_i' :: \kappa};\sem{\Sigma,\zeta \vdash \kappa_i <:: \ast})_\sigma(\gamma,a)^{~i \in 1..n}~\wedge$\\
$~~~~~~g \# (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ B_i \vdash \tau_i :: \iota_i})_{\sigma}(\gamma,a) \in \sem{m_i}^{~i \in 1..n} \}$ \\~\\

$= \{ g \in \mathit{Inst} \mid$ \\
$~~~~~~g(\epsilon) \in \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \mathit{KString(d[S/\zeta],\phi)}}_{\sigma}(\gamma,a)~\wedge$ \\
$~~~~~~\forall s \in \sem{\Sigma \mid \Gamma[S/\zeta] @ B_i[S/\zeta] \vdash \tau_i[S/\zeta] :: \mathit{KString}(d_i[S/\zeta],\phi_i)}_{\sigma}(\gamma,a).$\\
$~~~~~~~~g \! \mid_{[s]} \in (\sem{\Sigma \mid \Gamma[S/\zeta] @ A_i[S/\zeta] \vdash \tau_i'[S/\zeta] :: \kappa[S/\zeta]};\sem{\Sigma \vdash \kappa_i[S/\zeta] <:: \ast})_{\sigma}(\gamma,a)^{~i \in 1..n}~\wedge$\\
$~~~~~~g \# (\sem{\Sigma \mid \Gamma[S/\zeta] @ B_i[S/\zeta] \vdash \tau_i[S/\zeta] :: \mathit{KString}(d_i,\phi_i)[S/\zeta]})_\sigma(\gamma,a) \in \sem{m_i}^{~i \in 1..n} \}$\\~\\
 
$= \sem{\Sigma \mid \Gamma[S/\zeta] @ (A \capdot \bigcapdot_{i \in 1..n} (A_i \capdot B_i))[S/\zeta] \vdash (\tau.\{ [\tau_i] :^{m_i} \tau'_i \})[S/\zeta] :: \mathit{KTree}(d)[S/\zeta]  }_{\sigma}(\gamma,a)  $
\end{tabular}
\end{center}
and therefore,
$$\langle \mathit{id}, \sem{\Gamma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \capdot \bigcapdot_{i \in 1..n} (A_i \capdot B_i) \vdash \tau.\{ [\tau_i] :^{m_i} \tau_i' \} :: \mathit{KTree}(d))}$$ $$=$$ $$\sem{\Sigma \mid \Gamma[S/\zeta] @ (A \capdot \bigcapdot_{i \in 1..n} (A_i \capdot B_i))[S/\zeta] \vdash (\tau.\{ [\tau_i] :^{m_i} \tau'_i \})[S/\zeta] :: \mathit{KTree}(d)[S/\zeta]}$$
\item[Case \sc{Path}]:~\\
Applying lemma \ref{SWF-Subst} to $\Sigma,\zeta \vdash S_i^{~i \in 1..n}$ gives $$\Sigma \vdash S_i[S/\zeta]^{~i \in 1..n}$$ and $$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma, \zeta \vdash S_i} = \sem{\Sigma \vdash S_i[S/\zeta]}^{i \in 1..n}$$ 
Applying \begin{sc}Path\end{sc} gives 
$$\Sigma \mid \Gamma[S/\zeta] @ \{ (S_1[S/\zeta],\ldots,S_n[S/\zeta]).[\phi] \} \vdash S_1[S/\zeta],\ldots,S_n[S/\zeta]).[\phi] :: \mathit{KString}(\mathit{Prefix}~\epsilon,\phi)$$
i.e.,
$$\Sigma \mid \Gamma[S/\zeta] @ \{ (S_1,\ldots,S_n).[\phi] \}[S/\zeta] \vdash ((S_1,\ldots,S_n).[\phi])[S/\zeta] :: (\mathit{KString}(\mathit{Prefix}~\epsilon,\phi))[S/\zeta]$$
Furthermore, we have\\~\\
$(\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash \Gamma @ \{ (S_1, \ldots, S_n).[\phi] \} \vdash (S_1, \ldots, S_n).[\phi] :: \mathit{KString(\mathit{Prefix}~\epsilon,\phi)} })_{\sigma}(\gamma,a)$\\~\\
$= \sem{\Sigma,\zeta \vdash \Gamma @ \{ (S_1, \ldots, S_n).[\phi] \} \vdash (S_1, \ldots, S_n).[\phi] :: \mathit{KString(\mathit{Prefix}~\epsilon,\phi)}}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}(\gamma,a)$\\~\\
$= \{ s \in \mathit{Strings} \mid a([\sem{\Sigma,\zeta \vdash S_1}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle}, \ldots, \sem{\Sigma,\zeta \vdash S_n}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle}, s])\}$\\~\\
$= \{ s \in \mathit{Strings} \mid$ \\
$~~~~~~~~a \downarrow \downarrow [\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^*\sem{\Sigma,\zeta \vdash S_1}_\sigma, \ldots, \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^*\sem{\Sigma,\zeta \vdash S_n}_\sigma, s]\}$\\~\\
$= \{ s \in \mathit{Strings} \mid a \downarrow \downarrow [\sem{\Sigma \vdash S_1[S/\zeta]}_\sigma, \ldots, \sem{\Sigma \vdash S_n[S/\zeta]}_\sigma, s] \}$\\~\\
$= \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash (S_1[S/\zeta], \ldots S_n[S/\zeta]).[\phi] :: \mathit{KString}(\mathit{Prefix}~\epsilon,\phi)}_{\sigma}(\gamma, a)$\\~\\
$= \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash ((S_1, \ldots S_n).[\phi])[S/\zeta] :: (\mathit{KString}(\mathit{Prefix}~\epsilon,\phi))[S/\zeta]}_\sigma(\gamma,a)$

\item[Case \begin{sc}StrAbs\end{sc}]:~\\
Our assumption is a proof that $\Sigma,\zeta \mid \Gamma @ \emptyset \vdash \lambda \xi. \tau :: \forall \xi. \kappa$. Its top-level form must be an application of \begin{sc}StrAbs\end{sc} with premise $$\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa$$ Applying lemma \ref{K-exchng} to the premise gives a same-height proof that $$\Sigma,\xi,\zeta \mid \emptyset \vdash \tau :: \kappa$$ such that $$\sem{\Sigma,\xi,\zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa} = \mathit{swap}_{n,1}^*\sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$$ Applying the IH gives a proof of $$\Sigma,\xi \mid \Gamma[S/\zeta] @ \emptyset \vdash \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]$$ such that $$\sem{\Sigma,\xi \mid \Gamma[S/\zeta] @ \emptyset \vdash \tau[S/\zeta] :: \kappa[S/\zeta]} = \langle \mathit{id}, \sem{\Sigma,\xi \vdash S} \rangle^* \sem{\Sigma,\xi,\zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$$ Applying \begin{sc}TyAbs\end{sc} gives $$\Sigma \mid \Gamma[S/\zeta] @ \emptyset \vdash \lambda \xi. \tau[S/\zeta] :: \kappa[S/\zeta]$$  

Furthermore, we have\\~\\
$\sem{\Sigma,\xi \mid \Gamma[S/\zeta] @ \emptyset \vdash \tau[S/\zeta] :: \kappa[S/\zeta]}$\\~\\
$= \langle \mathit{id}_{\sem{\Sigma,\xi}}, \sem{\Sigma,\xi \vdash S} \rangle^* \sem{\Sigma,\xi,\zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$\\~\\
$= \langle \mathit{id}_{\sem{\Sigma,\xi}}, \sem{\Sigma,\xi \vdash S} \rangle^* \mathit{swap}_{n,1}^*\sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$\\~\\
$= (\langle \mathit{id}_{\sem{\Sigma,\xi}}, \sem{\Sigma,\xi \vdash S} \rangle;\mathit{swap}_{n,1})^* \sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$\\~\\
$= (\langle \mathit{id}_{\sem{\Sigma,\xi}}, \sem{\Sigma,\xi \vdash S} \rangle;\langle \langle \pi;\pi, \pi' \rangle, \pi;\pi' \rangle)^* \sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$\\~\\
$= (\langle \mathit{id}_{\sem{\Sigma,\xi}}, \pi;\sem{\Sigma \vdash S} \rangle;\langle \langle \pi;\pi, \pi' \rangle, \pi;\pi' \rangle)^* \sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$\\~\\
$= (\langle \mathit{id}_{\sem{\Sigma}}, \sem{\Sigma \vdash S} \rangle \times \mathit{id}_{\sem{\xi}})^* \sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$\\~\\ 
and therefore\\~\\
$(\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ \emptyset \vdash \lambda \xi. \tau :: \forall \xi. \kappa})_\sigma$\\~\\
$= (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \Pi_{\sem{\Sigma,\zeta}, \sem{\xi}} \sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa})_\sigma$\\~\\
$= (\Pi_{\sem{\Sigma},\sem{\xi}} (\langle \mathit{id}_{\sem{\Sigma}}, \sem{\Sigma \vdash S} \rangle \times \mathit{id}_{\sem{\xi}})^* \sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa})_\sigma$\\~\\
$= \Pi_{t \in \sem{\xi}}((\langle \mathit{id}_{\sem{\Sigma}}, \sem{\Sigma \vdash S} \rangle \times \mathit{id}_{\sem{\xi}})^* \sem{\Sigma,\zeta,\xi \mid \Gamma @ \emptyset \vdash \tau :: \kappa})_{\sigma,t}$\\~\\
$= \Pi_{t \in \sem{\xi}} \sem{\Sigma, \xi \mid \Gamma[S/\zeta] @ \emptyset \vdash \tau[S/\zeta] :: \kappa[S/\zeta]}_{\sigma, t}$\\~\\
$= \sem{\Sigma,\xi \mid \Gamma[S/\zeta] @ \emptyset \vdash \tau[S/\zeta] :: \kappa[S/\zeta]}^{\flat}_\sigma$\\~\\
$= \sem{\Sigma \mid \Gamma[S/\zeta] @ \emptyset \vdash \lambda \xi. \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]}_\sigma$

\item[Case \sc{StrApp}]:~\\
Our assumption is a proof that $\Sigma,\zeta \mid \Gamma @ A \vdash \tau~[T] :: \kappa[T/\xi]$. Its premises are 
$$\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa$$ 
and
$$\Sigma,\zeta \vdash T$$
Applying the IH gives 
$$\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]$$
and
$$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa} = \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]}$$

Applying Lemma \ref{SWF-Subst} gives 
$$\Sigma \vdash T[S/\zeta]$$
and
$$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \vdash T} = \sem{\Sigma \vdash T[S/\zeta]}$$

Applying \begin{sc}StrApp\end{sc} then gives $\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta]~[T] :: \kappa[S/\zeta][T/\xi]$.\\~\\
Furthermore, we have\\~\\
$(\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau~[T] :: \kappa[T/\xi]})_\sigma$\\~\\
$= (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \langle \mathit{id}, \sem{\Sigma,\zeta \vdash T} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_\sigma$\\~\\
$= ((\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle; \langle \mathit{id}, \sem{\Sigma,\zeta \vdash T} \rangle)^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_\sigma$\\~\\
$= ((\langle \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle, \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle;\sem{\Sigma,\zeta \vdash T} \rangle)^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_\sigma$\\~\\
$= ((\langle \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle, \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^*\sem{\Sigma,\zeta \vdash T} \rangle)^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_\sigma$\\~\\
$= (\langle \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle, \sem{\Sigma \vdash T[S/\zeta]} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_\sigma$\\~\\
$= (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle;\langle \mathit{id}, \pi;\sem{\Sigma \vdash T[S/\zeta]} \rangle)^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_\sigma$\\~\\
$= (\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle;\langle \mathit{id}, \sem{\Sigma,\xi \vdash T[S/\zeta]} \rangle)^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_\sigma$\\~\\
$= \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp_{\sigma, \sem{\Sigma \vdash S}_\sigma, \sem{\Sigma \vdash T[S/\zeta]}_\sigma}$\\~\\
$= f~~~\text{where } f(x) \defeq (~\sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}_{\sigma, \sem{\Sigma \vdash S}}(x)~)_{\sem{\Sigma \vdash T[S/\zeta]}_\sigma}$\\~\\
$= f~~~~\text{where } f(x) \defeq (~\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}(x)~)_{\sem{\Sigma \vdash T[S/\zeta]}_\sigma}$\\~\\
$= f~~~~\text{where } f(x) \defeq (~\sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]}_\sigma(x)~)_{\sem{\Sigma \vdash T[S/\zeta]}_\sigma}$\\~\\
$= \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]}^\sharp_{\sigma,\sem{\Sigma \vdash T[S/\zeta]}_\sigma}$\\~\\
$= (\langle \mathit{id}, \sem{\Sigma \vdash T[S/\zeta]} \rangle^* \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]}^\sharp)_\sigma$\\~\\
$= (\langle \mathit{id}, \sem{\Sigma \vdash T[S/\zeta]} \rangle^* \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \forall \xi. \kappa[S/\zeta]}^\sharp)_\sigma$\\~\\
$= \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta]~[T[S/\zeta]] :: \kappa[S/\zeta][T/\xi]}_\sigma$\\~\\
$= \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash (\tau~[T])[S/\zeta] :: \kappa[T/\xi][S/\zeta]}_\sigma$

%$= (\langle \mathit{id}, \sem{\Sigma,\xi \vdash T[S/\zeta]} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_{\sigma,\sem{\Sigma \vdash S}_\sigma}$\\~\\
%$= \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp_{\langle \mathit{id}, \sem{\Sigma,\xi \vdash T[S/\zeta]} \rangle(\sigma,\sem{\Sigma \vdash S}_\sigma)}$\\~\\

%$= (\sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}_{\sigma,\sem{\Sigma \vdash S}_\sigma})_{\sem{\Sigma \vdash T[S/\zeta]}_\sigma}$\\~\\



%$= \sem{\Sigma,\zeta \vdash \tau~[T] :: \kappa[T/\xi]}_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}$\\~\\
%$= (\langle \mathit{id}, \sem{\Sigma,\zeta \vdash T} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa}^\sharp)_{\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle(\sigma)}$\\~\\
%$= \sem{\Sigma \mid \Gamma[S/\zeta] \vdash \tau[S/\zeta]~[T[S/\zeta]] :: \kappa[T/\xi][S/\zeta]}$


%Noting that since $\Sigma \vdash S$ and $\zeta,\xi \not \in \Sigma$ we have $\kappa[T/\xi][S/\zeta] = \kappa[S/\zeta][T/\xi]$, we get
%$$\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \kappa[S/\zeta][T/\xi]$$
%and
%$$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ A \vdash \tau :: \forall \xi. \kappa} = \sem{\Sigma \mid \Gamma[S/\zeta] @ A[S/\zeta] \vdash \tau[S/\zeta] :: \kappa[S/\zeta][T/\xi]}$$
\item[Case \sc{TyApp}]:~\\

TODO.

\item[Case \sc{TyAbs}]:~\\

TODO.

\end{description}

\end{proof}

\subsection*{Soundness}

\subsubsection*{Index reduction}

Soundness for index reduction is standard. We must prove that $$\Sigma \mid \Gamma @ \emptyset \vdash (\lambda \zeta.\tau)~[S] :: \kappa[S/\zeta]$$ implies $$\Sigma \mid \Gamma @ \emptyset \vdash \tau[S/\zeta] :: \kappa[S/\zeta]$$ This is a straightforward corollary of the index substitution lemma.
We must further prove that $$\sem{\Sigma \mid \Gamma @ \emptyset \vdash (\lambda \zeta.\tau)~[S] :: \kappa[S/\zeta]}$$
is equal to $$\sem{\Sigma \mid \Gamma @ \emptyset \vdash \tau[S/\zeta] :: \kappa[S/\zeta]}$$ or, because $\zeta$ does not occur in $\Sigma$ and hence $\Gamma[S/\zeta] = \Gamma$, $$\sem{\Sigma \mid \Gamma[S/\zeta] @ \emptyset \vdash \tau[S/\zeta] :: \kappa[S/\zeta]}$$ which we've proven is equal to $$\langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$$
Unfolding the definition of $\sem{\Sigma \mid \Gamma @ \emptyset \vdash (\lambda \zeta. \tau)~[S]}$, it easy to see this:\\~\\
$\sem{\Sigma \mid \Gamma @ \emptyset \vdash (\lambda \zeta. \tau)~[S]}$\\
$= \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* (\sem{\Sigma,\zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa}^\flat)^\sharp$\\
$= \langle \mathit{id}, \sem{\Sigma \vdash S} \rangle^* \sem{\Sigma,\zeta \mid \Gamma @ \emptyset \vdash \tau :: \kappa}$ 

\subsubsection*{Type reduction}

Soundness for type reduction is also standard. We must prove that $$\Sigma \mid \Gamma @ A \vdash (\lambda x :: \kappa. \tau)~\tau' :: \iota$$ implies $$\Sigma \mid \Gamma @ A \vdash \tau[\tau'/x] :: \iota$$ This is a straigtforward corollary of the type substitution lemma. Furthermore, we must prove
TODO: explain the semantic side of this

\section*{Additional ideas}

Rather than just using a list of variables for the string index context, we should classify each
string index variable by the set of possible characters that may occur in the string. 
 
\end{document}
  
